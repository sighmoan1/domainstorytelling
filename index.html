<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Domain Storytelling</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --primary: #6366f1; --primary-dark: #4f46e5; --primary-light: #e0e7ff;
      --surface: #ffffff; --surface-dim: #f8fafc; --surface-alt: #f1f5f9;
      --border: #e2e8f0; --text: #1e293b; --text-muted: #64748b; --text-light: #94a3b8;
      --success: #10b981; --success-light: #d1fae5;
      --warning: #f59e0b; --warning-light: #fef3c7;
      --danger: #ef4444; --danger-light: #fee2e2;
      --radius: 12px; --radius-sm: 8px;
      --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--surface-dim); color: var(--text); min-height: 100vh; }
    .app { display: flex; flex-direction: column; height: 100vh; height: 100dvh; }
    .header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 10px 12px; display: flex; align-items: center; justify-content: space-between; gap: 8px; flex-shrink: 0; }
    .header h1 { font-size: 17px; font-weight: 600; display: flex; align-items: center; gap: 6px; }
    .header h1 .material-icons { color: var(--primary); font-size: 22px; }
    .header-actions { display: flex; gap: 4px; }
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 6px; padding: 10px 16px; border: none; border-radius: var(--radius); font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.15s; background: var(--surface); color: var(--text); }
    .btn-icon { width: 38px; height: 38px; padding: 0; border-radius: 10px; }
    .btn-sm { padding: 6px 10px; font-size: 13px; border-radius: var(--radius-sm); }
    .btn-sm .material-icons { font-size: 16px; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-dark); }
    .btn-secondary { background: var(--surface); border: 1px solid var(--border); }
    .btn-secondary:hover { background: var(--surface-dim); }
    .btn-ghost { background: transparent; color: var(--text-muted); }
    .btn-ghost:hover { background: var(--surface-alt); color: var(--text); }
    .btn .material-icons { font-size: 20px; }
    .btn:active { transform: scale(0.97); }
    .tabs { display: flex; background: var(--surface); border-bottom: 1px solid var(--border); flex-shrink: 0; }
    .tab { flex: 1; padding: 11px 12px; font-size: 13px; font-weight: 500; color: var(--text-muted); background: none; border: none; cursor: pointer; position: relative; display: flex; align-items: center; justify-content: center; gap: 5px; }
    .tab.active { color: var(--primary); }
    .tab.active::after { content: ''; position: absolute; bottom: 0; left: 12px; right: 12px; height: 2px; background: var(--primary); border-radius: 2px 2px 0 0; }
    .tab .material-icons { font-size: 18px; }
    .tab-badge { background: var(--danger); color: white; font-size: 10px; min-width: 18px; height: 18px; padding: 0 5px; border-radius: 9px; display: inline-flex; align-items: center; justify-content: center; margin-left: 4px; }
    .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    .panel { flex: 1; overflow: hidden; display: none; flex-direction: column; }
    .panel.active { display: flex; }
    .editor-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    .editor-toolbar { padding: 6px 10px; background: var(--surface); border-bottom: 1px solid var(--border); display: flex; gap: 4px; overflow-x: auto; align-items: center; flex-shrink: 0; }
    .toolbar-divider { width: 1px; height: 24px; background: var(--border); margin: 0 4px; flex-shrink: 0; }
    .editor-wrapper { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
    .editor { flex: 1; padding: 14px; font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace; font-size: 14px; line-height: 1.65; border: none; resize: none; background: var(--surface); color: var(--text); }
    .editor:focus { outline: none; }
    .editor::placeholder { color: var(--text-light); }
    .validation-bar { padding: 8px 14px; font-size: 12px; display: flex; align-items: center; gap: 6px; border-top: 1px solid var(--border); background: var(--surface); flex-shrink: 0; }
    .validation-bar.success { background: var(--success-light); color: #065f46; }
    .validation-bar.error { background: var(--danger-light); color: #991b1b; }
    .validation-bar .material-icons { font-size: 16px; }
    .validation-bar code { background: rgba(0,0,0,0.1); padding: 1px 4px; border-radius: 3px; font-family: monospace; font-size: 11px; }
    .autocomplete { position: absolute; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow-lg); max-height: 200px; overflow-y: auto; z-index: 50; display: none; min-width: 160px; }
    .autocomplete.visible { display: block; }
    .autocomplete-item { display: flex; align-items: center; gap: 8px; padding: 10px 12px; cursor: pointer; border-bottom: 1px solid var(--border); }
    .autocomplete-item:last-child { border-bottom: none; }
    .autocomplete-item:hover, .autocomplete-item.selected { background: var(--primary-light); }
    .autocomplete-item .material-icons { font-size: 20px; color: var(--primary); }
    .quick-bar { padding: 8px 10px; background: var(--surface-alt); border-top: 1px solid var(--border); display: flex; gap: 6px; overflow-x: auto; flex-shrink: 0; }
    .quick-chip { display: inline-flex; align-items: center; gap: 4px; padding: 8px 12px; background: var(--surface); border: 1px solid var(--border); border-radius: 20px; font-size: 13px; cursor: pointer; white-space: nowrap; }
    .quick-chip:hover { background: var(--primary-light); border-color: var(--primary); }
    .quick-chip .material-icons { font-size: 16px; color: var(--primary); }
    .diagram-container { flex: 1; overflow: hidden; position: relative; background: var(--surface); }
    .diagram-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; touch-action: none; }
    .diagram-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
    .participant { position: absolute; background: var(--surface); border: 2px solid var(--border); border-radius: var(--radius); padding: 10px 8px; text-align: center; cursor: move; touch-action: none; user-select: none; box-shadow: var(--shadow); min-width: 80px; max-width: 120px; transition: box-shadow 0.15s, border-color 0.15s; }
    .participant:hover { box-shadow: var(--shadow-lg); }
    .participant.dragging { box-shadow: var(--shadow-lg); border-color: var(--primary); z-index: 10; }
    .participant .material-icons { font-size: 28px; margin-bottom: 4px; }
    .participant-name { font-size: 11px; font-weight: 600; word-wrap: break-word; line-height: 1.25; }
    .participant-annotation { font-size: 9px; color: var(--text-muted); margin-top: 3px; font-style: italic; }
    .participant[data-type="person"] { border-color: #c7d2fe; }
    .participant[data-type="person"] .material-icons { color: #6366f1; }
    .participant[data-type="system"] { border-color: #a7f3d0; }
    .participant[data-type="system"] .material-icons { color: #10b981; }
    .participant[data-type="document"] { border-color: #fde68a; }
    .participant[data-type="document"] .material-icons { color: #f59e0b; }
    .participant[data-type="work"] { border-color: #fbcfe8; }
    .participant[data-type="work"] .material-icons { color: #ec4899; }
    .participant.highlighted { border-color: var(--primary) !important; box-shadow: 0 0 0 3px var(--primary-light), var(--shadow-lg); }
    .diagram-toolbar { position: absolute; top: 12px; left: 12px; display: flex; gap: 6px; z-index: 50; flex-wrap: wrap; }
    .diagram-toolbar .btn { box-shadow: var(--shadow); }
    .layout-dropdown { position: relative; }
    .layout-menu { position: absolute; top: 100%; left: 0; margin-top: 4px; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow-lg); min-width: 160px; display: none; z-index: 100; }
    .layout-menu.visible { display: block; }
    .layout-menu-item { display: flex; align-items: center; gap: 8px; padding: 10px 14px; cursor: pointer; font-size: 13px; border-bottom: 1px solid var(--border); }
    .layout-menu-item:last-child { border-bottom: none; }
    .layout-menu-item:hover { background: var(--primary-light); }
    .layout-menu-item .material-icons { font-size: 18px; color: var(--primary); }
    .story-selector { position: absolute; top: 12px; left: 50%; transform: translateX(-50%); display: none; align-items: center; gap: 4px; background: var(--surface); padding: 4px; border-radius: var(--radius); box-shadow: var(--shadow); z-index: 50; max-width: calc(100% - 240px); overflow-x: auto; }
    .story-selector.visible { display: flex; }
    .story-tab { padding: 8px 14px; font-size: 12px; font-weight: 500; border-radius: var(--radius-sm); cursor: pointer; white-space: nowrap; background: transparent; color: var(--text-muted); border: none; transition: all 0.15s; }
    .story-tab:hover { background: var(--surface-alt); color: var(--text); }
    .story-tab.active { background: var(--primary); color: white; }
    .diagram-controls { position: absolute; bottom: 16px; right: 16px; display: flex; flex-direction: column; gap: 6px; z-index: 50; }
    .diagram-controls .btn { box-shadow: var(--shadow); width: 42px; height: 42px; }
    .zoom-indicator { position: absolute; top: 12px; right: 12px; background: var(--surface); padding: 5px 10px; border-radius: 16px; font-size: 11px; font-weight: 600; box-shadow: var(--shadow); z-index: 50; }
    .flow-path { fill: none; stroke-width: 2; stroke-linecap: round; }
    .flow-label { font-size: 10px; font-weight: 500; fill: var(--text); }
    .flow-label-bg { fill: var(--surface); stroke: var(--border); stroke-width: 1; }
    .step-badge { font-size: 9px; font-weight: 700; fill: white; }
    .annotation-box { fill: #fef3c7; stroke: #fbbf24; stroke-width: 1; }
    .annotation-text { font-size: 9px; fill: #92400e; }
    .work-object-box { fill: #fce7f3; stroke: #ec4899; stroke-width: 1.5; }
    .work-object-text { font-size: 9px; font-weight: 500; fill: #be185d; }
    .control-handle { fill: var(--danger); stroke: white; stroke-width: 2; cursor: move; pointer-events: all; opacity: 0.8; }
    .steps-container { flex: 1; overflow-y: auto; padding: 14px; }
    .domain-header { background: var(--primary); color: white; padding: 14px 16px; margin: -14px -14px 14px -14px; display: flex; align-items: center; gap: 8px; }
    .domain-header h2 { font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
    .domain-header .material-icons { font-size: 20px; }
    .domain-notes-section { margin-bottom: 20px; }
    .domain-notes-title { font-size: 13px; font-weight: 600; color: var(--text-muted); margin-bottom: 8px; display: flex; align-items: center; gap: 6px; }
    .domain-notes-title .material-icons { font-size: 16px; }
    .domain-note { background: #fffbeb; border: 1px solid #fcd34d; border-left: 4px solid #f59e0b; border-radius: var(--radius-sm); padding: 10px 12px; margin-bottom: 8px; font-size: 13px; line-height: 1.5; }
    .domain-note-tag { display: inline-flex; align-items: center; gap: 4px; font-size: 10px; font-weight: 600; text-transform: uppercase; color: #92400e; margin-bottom: 4px; }
    .domain-note-tag .material-icons { font-size: 14px; }
    .domain-note-tag.user-story { color: #1d4ed8; }
    .domain-note-tag.requirement { color: #7c3aed; }
    .domain-note-tag.assumption { color: #0891b2; }
    .domain-note-tag.risk { color: #dc2626; }
    .flow-section { margin-bottom: 20px; }
    .flow-header { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
    .flow-badge { width: 26px; height: 26px; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: 600; }
    .flow-title { font-size: 15px; font-weight: 600; }
    .step-item { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 10px 12px; margin-bottom: 6px; font-size: 13px; cursor: pointer; transition: all 0.15s; }
    .step-item:hover { border-color: var(--primary); background: var(--primary-light); }
    .step-header { display: flex; align-items: flex-start; gap: 8px; }
    .step-number { display: inline-flex; align-items: center; justify-content: center; min-width: 20px; height: 20px; padding: 0 5px; background: var(--text-muted); color: white; border-radius: 5px; font-size: 10px; font-weight: 600; flex-shrink: 0; }
    .step-content { flex: 1; line-height: 1.4; }
    .step-actors strong { color: var(--primary); }
    .step-action { color: var(--text-muted); }
    .step-work-object { display: inline-flex; align-items: center; gap: 3px; background: #fce7f3; color: #be185d; padding: 1px 6px; border-radius: 4px; font-size: 11px; margin-left: 4px; }
    .step-annotation { margin-top: 6px; padding: 6px 10px; background: #fef3c7; border-radius: 6px; font-size: 11px; color: #92400e; }
    .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 30px; text-align: center; color: var(--text-muted); }
    .empty-state .material-icons { font-size: 56px; margin-bottom: 12px; opacity: 0.4; }
    .empty-state p { font-size: 14px; margin-bottom: 16px; }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); z-index: 200; display: none; align-items: flex-end; justify-content: center; }
    .modal-overlay.active { display: flex; }
    .modal { background: var(--surface); border-radius: 20px 20px 0 0; width: 100%; max-width: 560px; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column; animation: slideUp 0.25s ease; }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    .modal-header { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
    .modal-header h2 { font-size: 17px; }
    .modal-body { flex: 1; overflow-y: auto; padding: 16px 20px; }
    .syntax-block { background: var(--surface-dim); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 12px; font-family: 'SF Mono', monospace; font-size: 12px; line-height: 1.55; margin: 10px 0; white-space: pre-wrap; }
    .syntax-section { margin-bottom: 18px; }
    .syntax-section h3 { font-size: 13px; font-weight: 600; margin-bottom: 6px; display: flex; align-items: center; gap: 5px; }
    .syntax-section h3 .material-icons { font-size: 16px; color: var(--primary); }
    .syntax-section p { font-size: 12px; color: var(--text-muted); margin-bottom: 6px; }
    .template-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
    .template-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 12px; cursor: pointer; transition: all 0.15s; }
    .template-card:hover { border-color: var(--primary); background: var(--primary-light); }
    .template-card h4 { font-size: 13px; margin-bottom: 4px; display: flex; align-items: center; gap: 6px; }
    .template-card h4 .material-icons { font-size: 18px; color: var(--primary); }
    .template-card p { font-size: 11px; color: var(--text-muted); }
    .icon-picker-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); z-index: 200; display: none; align-items: flex-end; }
    .icon-picker-overlay.active { display: flex; }
    .icon-picker { background: var(--surface); border-radius: 20px 20px 0 0; width: 100%; max-height: 65vh; display: flex; flex-direction: column; animation: slideUp 0.25s ease; }
    .icon-picker-header { padding: 14px; border-bottom: 1px solid var(--border); }
    .icon-picker-header h3 { font-size: 15px; margin-bottom: 10px; }
    .icon-search { width: 100%; padding: 10px 14px; border: 1px solid var(--border); border-radius: var(--radius-sm); font-size: 15px; background: var(--surface-dim); color: var(--text); }
    .icon-search:focus { outline: none; border-color: var(--primary); }
    .icon-categories { display: flex; gap: 5px; margin-top: 10px; flex-wrap: wrap; }
    .icon-category { padding: 5px 10px; font-size: 11px; background: var(--surface-alt); border: 1px solid var(--border); border-radius: 14px; cursor: pointer; }
    .icon-category.active { background: var(--primary); color: white; border-color: var(--primary); }
    .icon-grid { flex: 1; overflow-y: auto; padding: 12px; display: grid; grid-template-columns: repeat(auto-fill, minmax(72px, 1fr)); gap: 6px; }
    .icon-item { display: flex; flex-direction: column; align-items: center; padding: 10px 4px; border-radius: var(--radius-sm); cursor: pointer; text-align: center; border: 1px solid transparent; }
    .icon-item:hover { background: var(--primary-light); border-color: var(--primary); }
    .icon-item .material-icons { font-size: 26px; color: var(--text); margin-bottom: 3px; }
    .icon-item span:last-child { font-size: 9px; color: var(--text-muted); }
    .toast { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); background: var(--text); color: var(--surface); padding: 10px 20px; border-radius: 20px; font-size: 13px; z-index: 300; animation: fadeInUp 0.2s ease; box-shadow: var(--shadow-lg); }
    @keyframes fadeInUp { from { opacity: 0; transform: translateX(-50%) translateY(16px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
    @media (min-width: 900px) {
      .tabs { display: none; }
      .main-content { flex-direction: row; }
      .panel.editor-panel { display: flex !important; width: 380px; min-width: 300px; max-width: 450px; border-right: 1px solid var(--border); }
      .panel.diagram-panel { display: flex !important; flex: 1; flex-direction: column; }
      .panel.steps-panel { display: none !important; }
      .desktop-steps-section { border-top: 1px solid var(--border); max-height: 280px; overflow-y: auto; background: var(--surface-dim); }
      .desktop-steps-section .steps-container { padding: 12px 16px; }
      .desktop-steps-section .domain-header { margin: -12px -16px 12px -16px; padding: 10px 16px; }
      .steps-toggle { display: flex; align-items: center; justify-content: space-between; padding: 8px 16px; background: var(--surface); border-bottom: 1px solid var(--border); cursor: pointer; font-size: 13px; font-weight: 500; color: var(--text-muted); }
      .steps-toggle:hover { background: var(--surface-dim); }
      .steps-toggle .material-icons { font-size: 20px; transition: transform 0.2s; }
      .steps-toggle.collapsed .material-icons { transform: rotate(180deg); }
      .modal { border-radius: 20px; max-height: 70vh; margin: auto; }
      .icon-picker { border-radius: 20px; max-height: 55vh; max-width: 480px; margin: auto; }
    }
    .measure-svg { position: absolute; visibility: hidden; pointer-events: none; }
    .export-container { position: absolute; left: -9999px; top: 0; background: white; padding: 20px; }
  </style>
</head>
<body>
  <div class="app">
    <header class="header">
      <h1><span class="material-icons">account_tree</span>Domain Story</h1>
      <div class="header-actions">
        <button class="btn btn-ghost btn-icon" id="templatesBtn" title="Templates"><span class="material-icons">dashboard</span></button>
        <button class="btn btn-ghost btn-icon" id="helpBtn" title="Help"><span class="material-icons">help_outline</span></button>
        <button class="btn btn-secondary btn-icon" id="iconPickerBtn" title="Icons"><span class="material-icons">emoji_symbols</span></button>
        <button class="btn btn-primary btn-icon" id="exportBtn" title="Export"><span class="material-icons">download</span></button>
      </div>
    </header>
    <nav class="tabs">
      <button class="tab active" data-panel="editor"><span class="material-icons">edit_note</span>Edit<span class="tab-badge" id="errorBadge" style="display:none">0</span></button>
      <button class="tab" data-panel="diagram"><span class="material-icons">schema</span>Diagram</button>
      <button class="tab" data-panel="steps"><span class="material-icons">list</span>Steps</button>
    </nav>
    <div class="main-content">
      <section class="panel editor-panel active" id="editor-panel">
        <div class="editor-container">
          <div class="editor-toolbar">
            <button class="btn btn-ghost btn-sm" id="undoBtn" title="Undo"><span class="material-icons">undo</span></button>
            <button class="btn btn-ghost btn-sm" id="redoBtn" title="Redo"><span class="material-icons">redo</span></button>
            <span class="toolbar-divider"></span>
            <button class="btn btn-ghost btn-sm" id="clearBtn" title="Clear"><span class="material-icons">delete_outline</span></button>
          </div>
          <div class="editor-wrapper">
            <textarea class="editor" id="storyInput" placeholder="# My Domain Story
> [user-story] As a user I want...
> [requirement] System must...

@Customer (person)
@System (computer)

## Main Flow
Customer, interacts with, System"></textarea>
            <div class="autocomplete" id="autocomplete"></div>
          </div>
          <div class="validation-bar" id="validationBar"><span class="material-icons">check_circle</span><span id="validationText">Ready</span></div>
          <div class="quick-bar">
            <span class="quick-chip" data-action="domain"><span class="material-icons">folder</span> Domain</span>
            <span class="quick-chip" data-action="actor"><span class="material-icons">person_add</span> Actor</span>
            <span class="quick-chip" data-action="flow"><span class="material-icons">arrow_forward</span> Flow</span>
            <span class="quick-chip" data-action="step"><span class="material-icons">add</span> Step</span>
            <span class="quick-chip" data-action="userstory"><span class="material-icons">auto_stories</span> Story</span>
            <span class="quick-chip" data-action="requirement"><span class="material-icons">checklist</span> Req</span>
          </div>
        </div>
      </section>
      <section class="panel diagram-panel" id="diagram-panel">
        <div class="diagram-container" id="diagramContainer">
          <div class="diagram-canvas" id="diagramCanvas"></div>
          <svg class="diagram-svg" id="diagramSvg"></svg>
          <div class="diagram-toolbar">
            <div class="layout-dropdown">
              <button class="btn btn-secondary btn-sm" id="layoutBtn"><span class="material-icons">auto_fix_high</span> Layout</button>
              <div class="layout-menu" id="layoutMenu">
                <div class="layout-menu-item" data-layout="flow"><span class="material-icons">arrow_forward</span> Flow (Left→Right)</div>
                <div class="layout-menu-item" data-layout="circular"><span class="material-icons">radio_button_unchecked</span> Circular</div>
                <div class="layout-menu-item" data-layout="force"><span class="material-icons">hub</span> Force-Directed</div>
                <div class="layout-menu-item" data-layout="grid"><span class="material-icons">grid_view</span> Grid</div>
              </div>
            </div>
          </div>
          <div class="story-selector" id="storySelector"></div>
          <div class="zoom-indicator" id="zoomIndicator">100%</div>
          <div class="diagram-controls">
            <button class="btn btn-secondary btn-icon" id="zoomInBtn"><span class="material-icons">add</span></button>
            <button class="btn btn-secondary btn-icon" id="zoomOutBtn"><span class="material-icons">remove</span></button>
            <button class="btn btn-secondary btn-icon" id="fitBtn"><span class="material-icons">fit_screen</span></button>
          </div>
          <div class="empty-state" id="emptyState"><span class="material-icons">draw</span><p>Your diagram will appear here</p><button class="btn btn-primary" id="startEditingBtn">Start Editing</button></div>
        </div>
        <div class="desktop-steps-section" id="desktopSteps" style="display:none">
          <div class="steps-toggle" id="stepsToggle"><span>Steps & Notes</span><span class="material-icons">expand_less</span></div>
          <div class="steps-container" id="desktopStepsContainer"></div>
        </div>
      </section>
      <section class="panel steps-panel" id="steps-panel">
        <div class="steps-container" id="stepsContainer"><div class="empty-state"><span class="material-icons">format_list_numbered</span><p>Steps will appear here</p></div></div>
      </section>
    </div>
  </div>
  <div class="export-container" id="exportContainer"></div>
  <div class="modal-overlay" id="helpModal">
    <div class="modal">
      <div class="modal-header"><h2>How to Use</h2><button class="btn btn-icon btn-ghost" id="closeHelpBtn"><span class="material-icons">close</span></button></div>
      <div class="modal-body">
        <div class="syntax-section"><h3><span class="material-icons">folder</span> Domain Story Groups</h3><p>Use # to create groups (As-Is, To-Be, releases)</p><div class="syntax-block"># Incident Record As-Is
# Incident Record To-Be</div></div>
        <div class="syntax-section"><h3><span class="material-icons">sticky_note_2</span> Notes & Requirements</h3><p>Use > with tags for notes</p><div class="syntax-block">> [user-story] As a user I want...
> [requirement] System must...
> [assumption] We assume...
> [risk] There is a risk...</div></div>
        <div class="syntax-section"><h3><span class="material-icons">person</span> Define Actors</h3><div class="syntax-block">@Customer (person)
@System (computer) "annotation"</div></div>
        <div class="syntax-section"><h3><span class="material-icons">sync_alt</span> Flows & Steps</h3><div class="syntax-block">## Checkout Process
Customer, adds item to, Cart {Product}
Cart, confirms to, Customer "success"</div></div>
      </div>
    </div>
  </div>
  <div class="modal-overlay" id="templatesModal">
    <div class="modal">
      <div class="modal-header"><h2>Templates</h2><button class="btn btn-icon btn-ghost" id="closeTemplatesBtn"><span class="material-icons">close</span></button></div>
      <div class="modal-body"><div class="template-grid" id="templateGrid"></div></div>
    </div>
  </div>
  <div class="icon-picker-overlay" id="iconPickerOverlay">
    <div class="icon-picker">
      <div class="icon-picker-header">
        <h3>Choose Icon</h3>
        <input type="text" class="icon-search" id="iconSearch" placeholder="Search icons..." />
        <div class="icon-categories" id="iconCategories">
          <span class="icon-category active" data-category="suggested">Suggested</span>
          <span class="icon-category" data-category="people">People</span>
          <span class="icon-category" data-category="tech">Tech</span>
          <span class="icon-category" data-category="all">All</span>
        </div>
      </div>
      <div class="icon-grid" id="iconGrid"></div>
    </div>
  </div>
  <svg class="measure-svg" id="measureSvg"><text id="measureText" font-size="10"></text></svg>
  <script>
    const FLOW_COLORS = ['#6366f1', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#14b8a6', '#f97316'];
    const DOMAIN_COLORS = ['#6366f1', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'];
    const NOTE_TYPES = {
      'user-story': { icon: 'auto_stories', label: 'User Story' },
      'requirement': { icon: 'checklist', label: 'Requirement' },
      'assumption': { icon: 'psychology', label: 'Assumption' },
      'risk': { icon: 'warning', label: 'Risk' },
      'note': { icon: 'sticky_note_2', label: 'Note' }
    };
    const ICON_CATEGORIES = {
      suggested: ['person', 'group', 'computer', 'cloud', 'storage', 'description', 'shopping_cart', 'payments', 'email', 'support_agent', 'dashboard', 'archive', 'checklist', 'api', 'folder'],
      people: ['person', 'group', 'groups', 'support_agent', 'engineering', 'supervisor_account', 'badge'],
      tech: ['computer', 'dns', 'storage', 'cloud', 'api', 'database', 'terminal', 'settings', 'dashboard', 'archive']
    };
    const TEMPLATES = [
      { id: 'evolution', title: 'As-Is → To-Be', icon: 'timeline', desc: 'Domain evolution', content: '# Current State (As-Is)\n> [assumption] Current process is manual\n\n@User (person)\n@LegacySystem (computer)\n\n## Manual Process\nUser, enters data into, LegacySystem\n\n# Target State (To-Be)\n> [user-story] As a user I want automated entry\n> [requirement] 99.9% uptime\n\n@User (person)\n@NewSystem (cloud)\n\n## Automated Process\nUser, submits to, NewSystem' },
      { id: 'simple', title: 'Simple Flow', icon: 'schema', desc: 'Basic example', content: '# My Domain\n> [note] Add notes here\n\n@Customer (person)\n@System (computer)\n\n## Main Flow\nCustomer, uses, System' },
      { id: 'blank', title: 'Blank', icon: 'note_add', desc: 'Start fresh', content: '# Domain Story\n\n@Actor1 (person)\n@Actor2 (computer)\n\n## Flow\nActor1, action, Actor2' }
    ];

    const state = { domains: [], currentDomain: -1, participants: {}, flows: [], zoom: 1, pan: { x: 0, y: 0 }, canvasSize: { width: 1600, height: 1200 }, history: [], historyIndex: -1, errors: [] };
    let allIcons = [], autocompleteIndex = -1;

    function init() {
      loadIcons();
      const ed = document.getElementById('storyInput');
      let debounce;
      ed.addEventListener('input', () => { clearTimeout(debounce); debounce = setTimeout(() => { saveHistory(); update(); }, 150); checkAutocomplete(); });
      ed.addEventListener('keydown', handleEditorKeys);
      ed.addEventListener('blur', () => setTimeout(hideAutocomplete, 150));
      
      document.getElementById('helpBtn').onclick = () => document.getElementById('helpModal').classList.add('active');
      document.getElementById('closeHelpBtn').onclick = () => document.getElementById('helpModal').classList.remove('active');
      document.getElementById('templatesBtn').onclick = openTemplates;
      document.getElementById('closeTemplatesBtn').onclick = () => document.getElementById('templatesModal').classList.remove('active');
      document.getElementById('iconPickerBtn').onclick = () => { document.getElementById('iconPickerOverlay').classList.add('active'); renderIconGrid('suggested'); };
      document.getElementById('exportBtn').onclick = exportPNG;
      document.getElementById('undoBtn').onclick = undo;
      document.getElementById('redoBtn').onclick = redo;
      document.getElementById('clearBtn').onclick = () => { if(confirm('Clear all?')) { ed.value = ''; saveHistory(); update(); } };
      document.getElementById('zoomInBtn').onclick = () => setZoom(state.zoom + 0.2);
      document.getElementById('zoomOutBtn').onclick = () => setZoom(state.zoom - 0.2);
      document.getElementById('fitBtn').onclick = fitToScreen;
      document.getElementById('startEditingBtn').onclick = () => switchTab('editor');
      document.getElementById('layoutBtn').onclick = () => document.getElementById('layoutMenu').classList.toggle('visible');
      
      document.querySelectorAll('.layout-menu-item').forEach(item => {
        item.onclick = () => { applyLayout(item.dataset.layout); document.getElementById('layoutMenu').classList.remove('visible'); };
      });
      
      document.querySelectorAll('.quick-chip').forEach(chip => chip.onclick = () => {
        const a = chip.dataset.action;
        if (a === 'domain') insertAtCursor('\n# New Domain Story\n> [note] Notes here\n\n');
        else if (a === 'actor') insertAtCursor('\n@NewActor (person)\n');
        else if (a === 'flow') insertAtCursor('\n## New Flow\n');
        else if (a === 'step') insertAtCursor('\nActor1, action, Actor2\n');
        else if (a === 'userstory') insertAtCursor('\n> [user-story] As a [role] I want [goal]\n');
        else if (a === 'requirement') insertAtCursor('\n> [requirement] System must...\n');
      });
      
      document.getElementById('iconSearch').oninput = e => renderIconGrid('all', e.target.value);
      document.getElementById('iconCategories').onclick = e => {
        if (e.target.classList.contains('icon-category')) {
          document.querySelectorAll('.icon-category').forEach(c => c.classList.remove('active'));
          e.target.classList.add('active');
          renderIconGrid(e.target.dataset.category, document.getElementById('iconSearch').value);
        }
      };
      
      document.querySelectorAll('.tab').forEach(t => t.onclick = () => switchTab(t.dataset.panel));
      ['helpModal', 'templatesModal', 'iconPickerOverlay'].forEach(id => {
        document.getElementById(id).onclick = e => { if (e.target.id === id) document.getElementById(id).classList.remove('active'); };
      });
      
      document.getElementById('stepsToggle').onclick = function() {
        this.classList.toggle('collapsed');
        document.getElementById('desktopStepsContainer').style.display = this.classList.contains('collapsed') ? 'none' : 'block';
      };
      
      document.addEventListener('click', e => { if (!e.target.closest('.layout-dropdown')) document.getElementById('layoutMenu').classList.remove('visible'); });
      document.addEventListener('keydown', e => {
        if (e.key === 'ArrowLeft' && state.domains.length > 1 && document.activeElement.tagName !== 'TEXTAREA') {
          e.preventDefault(); state.currentDomain = state.currentDomain <= 0 ? state.domains.length - 1 : state.currentDomain - 1; updateVisibleDomain(); renderStorySelector();
        }
        if (e.key === 'ArrowRight' && state.domains.length > 1 && document.activeElement.tagName !== 'TEXTAREA') {
          e.preventDefault(); state.currentDomain = state.currentDomain >= state.domains.length - 1 ? -1 : state.currentDomain + 1; updateVisibleDomain(); renderStorySelector();
        }
        if (e.key === 'Escape') { document.querySelectorAll('.modal-overlay, .icon-picker-overlay').forEach(m => m.classList.remove('active')); }
      });
      
      setupPinchZoom();
      window.addEventListener('resize', () => { renderSteps(); if (isDesktop()) setTimeout(fitToScreen, 100); });
      
      saveHistory();
      update();
      if (isDesktop()) setTimeout(fitToScreen, 100);
    }

    function isDesktop() { return window.innerWidth >= 900; }
    
    function saveHistory() {
      const text = document.getElementById('storyInput').value;
      if (state.history[state.historyIndex] === text) return;
      state.history = state.history.slice(0, state.historyIndex + 1);
      state.history.push(text);
      if (state.history.length > 50) state.history.shift();
      state.historyIndex = state.history.length - 1;
    }
    function undo() { if (state.historyIndex > 0) { state.historyIndex--; document.getElementById('storyInput').value = state.history[state.historyIndex]; update(); } }
    function redo() { if (state.historyIndex < state.history.length - 1) { state.historyIndex++; document.getElementById('storyInput').value = state.history[state.historyIndex]; update(); } }

    async function loadIcons() {
      try {
        const resp = await fetch('https://raw.githubusercontent.com/google/material-design-icons/master/font/MaterialIcons-Regular.codepoints');
        allIcons = (await resp.text()).split('\n').filter(Boolean).map(l => l.split(' ')[0]).sort();
      } catch (e) { allIcons = [...new Set(Object.values(ICON_CATEGORIES).flat())].sort(); }
      renderIconGrid('suggested');
    }
    
    function renderIconGrid(category = 'suggested', filter = '') {
      const grid = document.getElementById('iconGrid');
      let icons = category === 'all' ? allIcons : (ICON_CATEGORIES[category] || ICON_CATEGORIES.suggested);
      if (filter) icons = allIcons.filter(i => i.includes(filter.toLowerCase()));
      grid.innerHTML = icons.slice(0, 80).map(icon => `<div class="icon-item" data-icon="${icon}"><span class="material-icons">${icon}</span><span>${icon.replace(/_/g, ' ')}</span></div>`).join('');
      grid.querySelectorAll('.icon-item').forEach(item => item.addEventListener('click', () => {
        insertAtCursor(`(${item.dataset.icon})`);
        showToast(`Added: ${item.dataset.icon}`);
        document.getElementById('iconPickerOverlay').classList.remove('active');
      }));
    }

    function parseDomainStory(input) {
      const lines = input.split('\n');
      const domains = [], errors = [];
      let currentDomain = null, currentFlow = null, flowNum = 0;
      
      lines.forEach((rawLine, lineIdx) => {
        const line = rawLine.trim();
        if (!line) return;
        const lineNum = lineIdx + 1;
        
        if (line.match(/^#[^#]/)) {
          const title = line.replace(/^#\s*/, '').trim();
          flowNum = 0;
          currentDomain = { title, notes: [], participants: [], flows: [], color: DOMAIN_COLORS[domains.length % DOMAIN_COLORS.length] };
          domains.push(currentDomain);
          currentFlow = null;
          return;
        }
        
        if (line.startsWith('>')) {
          const noteMatch = line.match(/^>\s*\[(\w+(?:-\w+)?)\]\s*(.+)$/);
          if (noteMatch) {
            const note = { type: noteMatch[1].toLowerCase(), content: noteMatch[2] };
            if (currentDomain) currentDomain.notes.push(note);
          } else {
            const simpleNote = line.replace(/^>\s*/, '');
            if (simpleNote && currentDomain) currentDomain.notes.push({ type: 'note', content: simpleNote });
          }
          return;
        }
        
        if (!currentDomain) {
          currentDomain = { title: 'Domain Story', notes: [], participants: [], flows: [], color: DOMAIN_COLORS[0] };
          domains.push(currentDomain);
        }
        
        if (line.startsWith('@')) {
          const m = line.match(/^@(.+?)\s*\((\w+)\)\s*(?:"(.+)")?$/);
          if (m) currentDomain.participants.push({ name: m[1].trim(), icon: m[2].trim(), annotation: m[3] || null });
          else errors.push({ line: lineNum, msg: 'Invalid actor', hint: '@Name (icon)' });
          return;
        }
        
        if (line.startsWith('##')) {
          flowNum++;
          const title = line.replace(/^#+\s*/, '').trim();
          currentFlow = { number: flowNum, title: title || 'Untitled', steps: [] };
          currentDomain.flows.push(currentFlow);
          return;
        }
        
        if (line.startsWith('//')) return;
        
        if (line.includes(',')) {
          if (!currentFlow) { errors.push({ line: lineNum, msg: 'Step outside flow', hint: 'Add ## Flow first' }); return; }
          const actorNames = currentDomain.participants.map(p => p.name);
          const parsed = parseStep(line, actorNames, lineNum, errors);
          if (parsed) currentFlow.steps.push({ ...parsed, controlX: null, controlY: null });
        }
      });
      
      return { domains, errors };
    }

    function parseStep(line, actorNames, lineNum, errors) {
      let annotation = null, workObject = null, cleanLine = line;
      const annM = cleanLine.match(/"([^"]+)"\s*$/);
      if (annM) { annotation = annM[1]; cleanLine = cleanLine.replace(annM[0], '').trim(); }
      const workM = cleanLine.match(/\{([^}]+)\}\s*$/);
      if (workM) { workObject = workM[1].trim(); cleanLine = cleanLine.replace(workM[0], '').trim(); }
      const parts = cleanLine.split(',').map(p => p.trim()).filter(p => p);
      if (parts.length < 2) { errors.push({ line: lineNum, msg: 'Need 2+ parts', hint: 'From, action, To' }); return null; }
      const fromName = parts[0], toName = parts[parts.length - 1];
      const fromMatch = actorNames.find(n => n.toLowerCase() === fromName.toLowerCase());
      const toMatch = actorNames.find(n => n.toLowerCase() === toName.toLowerCase());
      if (!fromMatch) errors.push({ line: lineNum, msg: `Unknown: ${fromName}`, hint: '@' + fromName + ' (icon)' });
      if (!toMatch && toName.toLowerCase() !== fromName.toLowerCase()) errors.push({ line: lineNum, msg: `Unknown: ${toName}`, hint: '@' + toName + ' (icon)' });
      return { from: fromMatch || fromName, action: parts.length > 2 ? parts.slice(1, -1).join(', ') : '', to: toMatch || toName, workObject, annotation };
    }

    function validate() {
      const bar = document.getElementById('validationBar'), text = document.getElementById('validationText'), badge = document.getElementById('errorBadge');
      const input = document.getElementById('storyInput').value;
      if (!input.trim()) { bar.className = 'validation-bar'; text.innerHTML = '<span class="material-icons">edit</span> Empty'; badge.style.display = 'none'; return; }
      if (state.errors.length > 0) {
        const err = state.errors[0];
        bar.className = 'validation-bar error';
        text.innerHTML = `<span class="material-icons">error</span> Line ${err.line}: ${err.msg} <code>${err.hint}</code>`;
        badge.textContent = state.errors.length; badge.style.display = 'inline-flex'; return;
      }
      const actors = Object.keys(state.participants).length;
      const steps = state.flows.reduce((s, f) => s + f.steps.length, 0);
      bar.className = 'validation-bar success';
      text.innerHTML = `<span class="material-icons">check_circle</span> ${state.domains.length} domain${state.domains.length !== 1 ? 's' : ''}, ${actors} actors, ${steps} steps`;
      badge.style.display = 'none';
    }

    function renderStorySelector() {
      const selector = document.getElementById('storySelector');
      if (state.domains.length <= 1) { selector.classList.remove('visible'); return; }
      selector.classList.add('visible');
      const tabs = state.domains.map((d, i) => 
        `<button class="story-tab${state.currentDomain === i ? ' active' : ''}" data-index="${i}" style="${state.currentDomain === i ? 'background:' + d.color : ''}">${d.title}</button>`
      ).join('');
      selector.innerHTML = `<button class="story-tab${state.currentDomain === -1 ? ' active' : ''}" data-index="-1">All</button>${tabs}`;
      selector.querySelectorAll('.story-tab').forEach(tab => {
        tab.onclick = () => { state.currentDomain = parseInt(tab.dataset.index); updateVisibleDomain(); renderStorySelector(); };
      });
    }
    
    function updateVisibleDomain() {
      const visible = state.currentDomain === -1 ? state.domains : (state.domains[state.currentDomain] ? [state.domains[state.currentDomain]] : []);
      const newParticipants = {};
      visible.forEach((domain, di) => {
        domain.participants.forEach(p => {
          const key = state.domains.length > 1 ? `${p.name}__${state.domains.indexOf(domain)}` : p.name;
          if (!newParticipants[key]) newParticipants[key] = { ...p, domainIndex: state.domains.indexOf(domain), displayName: p.name, x: null, y: null };
        });
      });
      Object.entries(state.participants).forEach(([key, p]) => {
        if (newParticipants[key]) { newParticipants[key].x = p.x; newParticipants[key].y = p.y; newParticipants[key].element = p.element; }
        else if (p.element) p.element.remove();
      });
      state.participants = newParticipants;
      state.flows = [];
      visible.forEach(domain => domain.flows.forEach(f => state.flows.push({ ...f, domainTitle: domain.title, domainColor: domain.color })));
      positionNewParticipants();
      renderParticipants();
      renderFlows();
      renderSteps();
      fitToScreen();
    }

    function positionNewParticipants() {
      const unplaced = Object.values(state.participants).filter(p => p.x === null);
      if (!unplaced.length) return;
      const cx = state.canvasSize.width / 2, cy = state.canvasSize.height / 2, r = Math.min(cx, cy) * 0.6;
      unplaced.forEach((p, i) => {
        const angle = (i / unplaced.length) * 2 * Math.PI - Math.PI / 2;
        p.x = cx + Math.cos(angle) * r;
        p.y = cy + Math.sin(angle) * r;
      });
    }

    function applyLayout(type) {
      const actors = Object.values(state.participants);
      if (!actors.length) return;
      const cx = state.canvasSize.width / 2, cy = state.canvasSize.height / 2, padding = 150;
      state.flows.forEach(f => f.steps.forEach(s => { s.controlX = null; s.controlY = null; }));
      
      if (type === 'circular') {
        const radius = Math.min(cx, cy) - padding;
        actors.forEach((p, i) => { const angle = (i / actors.length) * 2 * Math.PI - Math.PI / 2; p.x = cx + Math.cos(angle) * radius; p.y = cy + Math.sin(angle) * radius; });
      } else if (type === 'grid') {
        const cols = Math.ceil(Math.sqrt(actors.length));
        const cellW = (state.canvasSize.width - padding * 2) / cols;
        const cellH = (state.canvasSize.height - padding * 2) / Math.ceil(actors.length / cols);
        actors.forEach((p, i) => { p.x = padding + (i % cols) * cellW + cellW / 2; p.y = padding + Math.floor(i / cols) * cellH + cellH / 2; });
      } else if (type === 'flow') {
        const levels = new Map(), visited = new Set(), actorKeys = Object.keys(state.participants);
        const targets = new Set();
        state.flows.forEach(f => f.steps.forEach(s => { const tk = actorKeys.find(k => state.participants[k].displayName === s.to); if (tk) targets.add(tk); }));
        const roots = actorKeys.filter(k => !targets.has(k));
        if (!roots.length && actorKeys.length) roots.push(actorKeys[0]);
        let queue = roots.map(k => ({ key: k, level: 0 }));
        roots.forEach(k => { levels.set(k, 0); visited.add(k); });
        while (queue.length) {
          const { key, level } = queue.shift();
          const actor = state.participants[key];
          state.flows.forEach(f => f.steps.forEach(s => {
            if (s.from === actor.displayName) {
              const tk = actorKeys.find(k => state.participants[k].displayName === s.to);
              if (tk && !visited.has(tk)) { levels.set(tk, level + 1); visited.add(tk); queue.push({ key: tk, level: level + 1 }); }
            }
          }));
        }
        actorKeys.forEach(k => { if (!levels.has(k)) levels.set(k, levels.size); });
        const byLevel = {};
        levels.forEach((lvl, key) => { if (!byLevel[lvl]) byLevel[lvl] = []; byLevel[lvl].push(key); });
        const numLevels = Object.keys(byLevel).length;
        const levelWidth = (state.canvasSize.width - padding * 2) / Math.max(numLevels, 1);
        Object.entries(byLevel).forEach(([lvl, keys]) => {
          const levelHeight = (state.canvasSize.height - padding * 2) / keys.length;
          keys.forEach((key, i) => { const p = state.participants[key]; p.x = padding + parseInt(lvl) * levelWidth + levelWidth / 2; p.y = padding + i * levelHeight + levelHeight / 2; });
        });
      } else if (type === 'force') {
        const iterations = 80, repulsion = 18000, attraction = 0.04, damping = 0.85;
        const actorKeys = Object.keys(state.participants);
        const edges = [];
        state.flows.forEach(f => f.steps.forEach(s => {
          const fk = actorKeys.find(k => state.participants[k].displayName === s.from);
          const tk = actorKeys.find(k => state.participants[k].displayName === s.to);
          if (fk && tk) edges.push({ from: fk, to: tk });
        }));
        const vel = {};
        actorKeys.forEach(k => { vel[k] = { x: 0, y: 0 }; });
        for (let iter = 0; iter < iterations; iter++) {
          for (let i = 0; i < actorKeys.length; i++) {
            for (let j = i + 1; j < actorKeys.length; j++) {
              const a = state.participants[actorKeys[i]], b = state.participants[actorKeys[j]];
              const dx = b.x - a.x, dy = b.y - a.y, dist = Math.sqrt(dx*dx + dy*dy) || 1;
              const force = repulsion / (dist * dist), fx = (dx / dist) * force, fy = (dy / dist) * force;
              vel[actorKeys[i]].x -= fx; vel[actorKeys[i]].y -= fy;
              vel[actorKeys[j]].x += fx; vel[actorKeys[j]].y += fy;
            }
          }
          edges.forEach(e => {
            const a = state.participants[e.from], b = state.participants[e.to];
            const dx = b.x - a.x, dy = b.y - a.y, dist = Math.sqrt(dx*dx + dy*dy) || 1;
            const force = dist * attraction, fx = (dx / dist) * force, fy = (dy / dist) * force;
            vel[e.from].x += fx; vel[e.from].y += fy;
            vel[e.to].x -= fx; vel[e.to].y -= fy;
          });
          actorKeys.forEach(k => {
            const p = state.participants[k];
            p.x += vel[k].x; p.y += vel[k].y;
            vel[k].x *= damping; vel[k].y *= damping;
            p.x = Math.max(padding, Math.min(state.canvasSize.width - padding, p.x));
            p.y = Math.max(padding, Math.min(state.canvasSize.height - padding, p.y));
          });
        }
      }
      renderParticipants(); renderFlows(); fitToScreen(); showToast(`Applied ${type} layout`);
    }

    function getActorType(icon) {
      if (ICON_CATEGORIES.people.includes(icon)) return 'person';
      if (ICON_CATEGORIES.tech.includes(icon)) return 'system';
      return 'work';
    }

    function renderParticipants() {
      const canvas = document.getElementById('diagramCanvas');
      canvas.querySelectorAll('.participant').forEach(el => { if (!state.participants[el.dataset.key]) el.remove(); });
      Object.entries(state.participants).forEach(([key, p]) => {
        if (!p.element) {
          const div = document.createElement('div');
          div.className = 'participant'; div.dataset.key = key;
          canvas.appendChild(div); p.element = div;
          makeDraggable(div, p);
        }
        p.element.dataset.type = getActorType(p.icon);
        p.element.innerHTML = `<span class="material-icons">${p.icon}</span><div class="participant-name">${p.displayName}</div>${p.annotation ? `<div class="participant-annotation">${p.annotation}</div>` : ''}`;
        const w = p.element.offsetWidth || 90, h = p.element.offsetHeight || 70;
        p.element.style.left = `${(p.x - w/2) * state.zoom + state.pan.x}px`;
        p.element.style.top = `${(p.y - h/2) * state.zoom + state.pan.y}px`;
        p.element.style.transform = `scale(${state.zoom})`;
        p.element.style.transformOrigin = 'top left';
      });
    }

    function makeDraggable(el, p) {
      let startX, startY, startPx, startPy, dragging = false;
      function onStart(e) { e.preventDefault(); dragging = true; el.classList.add('dragging'); const t = e.touches ? e.touches[0] : e; startX = t.clientX; startY = t.clientY; startPx = p.x; startPy = p.y; document.addEventListener('mousemove', onMove); document.addEventListener('mouseup', onEnd); document.addEventListener('touchmove', onMove, { passive: false }); document.addEventListener('touchend', onEnd); }
      function onMove(e) { if (!dragging) return; e.preventDefault(); const t = e.touches ? e.touches[0] : e; p.x = startPx + (t.clientX - startX) / state.zoom; p.y = startPy + (t.clientY - startY) / state.zoom; renderParticipants(); renderFlows(); }
      function onEnd() { dragging = false; el.classList.remove('dragging'); document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onEnd); document.removeEventListener('touchmove', onMove); document.removeEventListener('touchend', onEnd); }
      el.addEventListener('mousedown', onStart); el.addEventListener('touchstart', onStart, { passive: false });
    }

    function renderFlows() {
      const svg = document.getElementById('diagramSvg');
      svg.innerHTML = '';
      const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
      FLOW_COLORS.forEach((c, i) => {
        const m = document.createElementNS('http://www.w3.org/2000/svg', 'marker');
        m.setAttribute('id', `arrow-${i}`); m.setAttribute('markerWidth', '8'); m.setAttribute('markerHeight', '8');
        m.setAttribute('refX', '7'); m.setAttribute('refY', '3'); m.setAttribute('orient', 'auto');
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('d', 'M0,0 L0,6 L8,3 Z'); path.setAttribute('fill', c);
        m.appendChild(path); defs.appendChild(m);
      });
      svg.appendChild(defs);
      const actorKeys = Object.keys(state.participants);
      
      state.flows.forEach((flow, fi) => {
        const color = FLOW_COLORS[fi % FLOW_COLORS.length];
        flow.steps.forEach((step, si) => {
          const fromKey = actorKeys.find(k => state.participants[k].displayName === step.from);
          const toKey = actorKeys.find(k => state.participants[k].displayName === step.to);
          const fromP = state.participants[fromKey], toP = state.participants[toKey];
          if (!fromP || !toP) return;
          
          if (step.controlX === null) {
            const mx = (fromP.x + toP.x) / 2, my = (fromP.y + toP.y) / 2;
            const dx = toP.x - fromP.x, dy = toP.y - fromP.y, len = Math.sqrt(dx*dx + dy*dy) || 1;
            const offset = (si - (flow.steps.length - 1) / 2) * 50;
            step.controlX = mx + (-dy / len) * offset;
            step.controlY = my + (dx / len) * offset;
          }
          
          const fromE = getBoxEdge(fromP, step.controlX, step.controlY);
          const toE = getBoxEdge(toP, step.controlX, step.controlY);
          const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
          g.setAttribute('transform', `translate(${state.pan.x}, ${state.pan.y}) scale(${state.zoom})`);
          
          const pathEl = document.createElementNS('http://www.w3.org/2000/svg', 'path');
          pathEl.setAttribute('d', `M ${fromE.x},${fromE.y} Q ${step.controlX},${step.controlY} ${toE.x},${toE.y}`);
          pathEl.setAttribute('stroke', color); pathEl.classList.add('flow-path');
          pathEl.setAttribute('marker-end', `url(#arrow-${fi % FLOW_COLORS.length})`);
          g.appendChild(pathEl);
          
          const badgePos = bezierPoint(0.15, fromE, { x: step.controlX, y: step.controlY }, toE);
          const badge = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
          badge.setAttribute('cx', badgePos.x); badge.setAttribute('cy', badgePos.y - 12);
          badge.setAttribute('r', 9); badge.setAttribute('fill', color); g.appendChild(badge);
          const bt = document.createElementNS('http://www.w3.org/2000/svg', 'text');
          bt.setAttribute('x', badgePos.x); bt.setAttribute('y', badgePos.y - 9);
          bt.setAttribute('text-anchor', 'middle'); bt.classList.add('step-badge');
          bt.textContent = `${flow.number}.${si + 1}`; g.appendChild(bt);
          
          if (step.action) {
            const labelPos = bezierPoint(0.5, fromE, { x: step.controlX, y: step.controlY }, toE);
            const tm = measureText(step.action, 10);
            const bg = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            bg.setAttribute('x', labelPos.x - tm.width/2 - 5); bg.setAttribute('y', labelPos.y - 20);
            bg.setAttribute('width', tm.width + 10); bg.setAttribute('height', 16);
            bg.setAttribute('rx', 3); bg.classList.add('flow-label-bg'); g.appendChild(bg);
            const tx = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            tx.setAttribute('x', labelPos.x); tx.setAttribute('y', labelPos.y - 9);
            tx.setAttribute('text-anchor', 'middle'); tx.classList.add('flow-label');
            tx.textContent = step.action; g.appendChild(tx);
          }
          
          if (step.workObject) {
            const woPos = bezierPoint(0.8, fromE, { x: step.controlX, y: step.controlY }, toE);
            const tm = measureText(step.workObject, 9);
            const r = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            r.setAttribute('x', woPos.x - tm.width/2 - 6); r.setAttribute('y', woPos.y + 8);
            r.setAttribute('width', tm.width + 12); r.setAttribute('height', 14);
            r.setAttribute('rx', 3); r.classList.add('work-object-box'); g.appendChild(r);
            const t = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            t.setAttribute('x', woPos.x); t.setAttribute('y', woPos.y + 18);
            t.setAttribute('text-anchor', 'middle'); t.classList.add('work-object-text');
            t.textContent = step.workObject; g.appendChild(t);
          }
          
          if (step.annotation) {
            const annPos = bezierPoint(step.workObject ? 0.65 : 0.75, fromE, { x: step.controlX, y: step.controlY }, toE);
            const tm = measureText(step.annotation, 9);
            const r = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            r.setAttribute('x', annPos.x - tm.width/2 - 6); r.setAttribute('y', annPos.y - 20);
            r.setAttribute('width', tm.width + 12); r.setAttribute('height', 14);
            r.setAttribute('rx', 3); r.classList.add('annotation-box'); g.appendChild(r);
            const t = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            t.setAttribute('x', annPos.x); t.setAttribute('y', annPos.y - 10);
            t.setAttribute('text-anchor', 'middle'); t.classList.add('annotation-text');
            t.textContent = step.annotation; g.appendChild(t);
          }
          
          const handle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
          handle.setAttribute('cx', step.controlX); handle.setAttribute('cy', step.controlY);
          handle.setAttribute('r', 6); handle.classList.add('control-handle');
          g.appendChild(handle);
          makeHandleDraggable(handle, step);
          svg.appendChild(g);
        });
      });
    }

    function makeHandleDraggable(h, step) {
      let dragging = false, startX, startY, startCX, startCY;
      function onStart(e) { e.preventDefault(); e.stopPropagation(); dragging = true; const t = e.touches ? e.touches[0] : e; startX = t.clientX; startY = t.clientY; startCX = step.controlX; startCY = step.controlY; document.addEventListener('mousemove', onMove); document.addEventListener('mouseup', onEnd); document.addEventListener('touchmove', onMove, { passive: false }); document.addEventListener('touchend', onEnd); }
      function onMove(e) { if (!dragging) return; e.preventDefault(); const t = e.touches ? e.touches[0] : e; step.controlX = startCX + (t.clientX - startX) / state.zoom; step.controlY = startCY + (t.clientY - startY) / state.zoom; renderFlows(); }
      function onEnd() { dragging = false; document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onEnd); document.removeEventListener('touchmove', onMove); document.removeEventListener('touchend', onEnd); }
      h.style.pointerEvents = 'all'; h.addEventListener('mousedown', onStart); h.addEventListener('touchstart', onStart, { passive: false });
    }

    function getBoxEdge(p, toX, toY) {
      const el = p.element, w = (el?.offsetWidth || 90) / 2 + 6, h = (el?.offsetHeight || 70) / 2 + 6;
      const dx = toX - p.x, dy = toY - p.y;
      if (dx === 0 && dy === 0) return { x: p.x, y: p.y };
      const scale = Math.min(w / Math.abs(dx || 0.001), h / Math.abs(dy || 0.001));
      return { x: p.x + dx * scale, y: p.y + dy * scale };
    }
    function bezierPoint(t, p0, p1, p2) { const mt = 1 - t; return { x: mt*mt*p0.x + 2*mt*t*p1.x + t*t*p2.x, y: mt*mt*p0.y + 2*mt*t*p1.y + t*t*p2.y }; }
    function measureText(text, size) { const el = document.getElementById('measureText'); el.setAttribute('font-size', size); el.textContent = text; return el.getBBox(); }

    function renderSteps() {
      const visible = state.currentDomain === -1 ? state.domains : (state.domains[state.currentDomain] ? [state.domains[state.currentDomain]] : []);
      let html = '';
      
      visible.forEach(domain => {
        html += `<div class="domain-header" style="background:${domain.color}"><h2><span class="material-icons">folder</span>${domain.title}</h2></div>`;
        if (domain.notes.length > 0) {
          html += '<div class="domain-notes-section"><div class="domain-notes-title"><span class="material-icons">sticky_note_2</span> Notes & Requirements</div>';
          domain.notes.forEach(note => {
            const noteType = NOTE_TYPES[note.type] || NOTE_TYPES.note;
            html += `<div class="domain-note"><div class="domain-note-tag ${note.type}"><span class="material-icons">${noteType.icon}</span> ${noteType.label}</div><div class="domain-note-content">${note.content}</div></div>`;
          });
          html += '</div>';
        }
        const domainFlows = state.flows.filter(f => f.domainTitle === domain.title);
        domainFlows.forEach((f, fi) => {
          const color = FLOW_COLORS[fi % FLOW_COLORS.length];
          html += `<div class="flow-section"><div class="flow-header"><div class="flow-badge" style="background:${color}">${f.number}</div><div class="flow-title">${f.title}</div></div>`;
          f.steps.forEach((s, si) => {
            html += `<div class="step-item" data-from="${s.from}" data-to="${s.to}"><div class="step-header"><span class="step-number" style="background:${color}">${si + 1}</span><div class="step-content"><span class="step-actors"><strong>${s.from}</strong> → <strong>${s.to}</strong></span>${s.workObject ? `<span class="step-work-object">${s.workObject}</span>` : ''}${s.action ? `<div class="step-action">${s.action}</div>` : ''}${s.annotation ? `<div class="step-annotation">${s.annotation}</div>` : ''}</div></div></div>`;
          });
          html += '</div>';
        });
      });
      
      if (!html) html = '<div class="empty-state"><span class="material-icons">format_list_numbered</span><p>Steps will appear here</p></div>';
      document.getElementById('stepsContainer').innerHTML = html;
      document.getElementById('desktopStepsContainer').innerHTML = html;
      
      document.querySelectorAll('.step-item').forEach(item => {
        item.onclick = () => {
          Object.values(state.participants).forEach(p => {
            if (p.displayName === item.dataset.from || p.displayName === item.dataset.to) {
              p.element?.classList.add('highlighted');
              setTimeout(() => p.element?.classList.remove('highlighted'), 2000);
            }
          });
        };
      });
      
      const desktopSteps = document.getElementById('desktopSteps');
      if (isDesktop() && state.flows.length > 0) desktopSteps.style.display = 'block';
      else if (isDesktop()) desktopSteps.style.display = 'none';
    }

    function setZoom(z) { state.zoom = Math.max(0.2, Math.min(2, z)); document.getElementById('zoomIndicator').textContent = `${Math.round(state.zoom * 100)}%`; renderParticipants(); renderFlows(); }
    
    function fitToScreen() {
      const ps = Object.values(state.participants);
      if (!ps.length) return;
      const rect = document.getElementById('diagramContainer').getBoundingClientRect();
      let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;
      ps.forEach(p => { minX = Math.min(minX, p.x - 70); maxX = Math.max(maxX, p.x + 70); minY = Math.min(minY, p.y - 50); maxY = Math.max(maxY, p.y + 50); });
      const w = maxX - minX, h = maxY - minY, pad = 80;
      state.zoom = Math.min((rect.width - pad*2) / w, (rect.height - pad*2) / h, 1.5);
      state.pan.x = (rect.width - w * state.zoom) / 2 - minX * state.zoom;
      state.pan.y = (rect.height - h * state.zoom) / 2 - minY * state.zoom;
      document.getElementById('zoomIndicator').textContent = `${Math.round(state.zoom * 100)}%`;
      renderParticipants(); renderFlows();
    }
    
    function setupPinchZoom() {
      let lastDist = 0;
      const container = document.getElementById('diagramContainer');
      container.addEventListener('touchstart', e => { if (e.touches.length === 2) { const dx = e.touches[0].clientX - e.touches[1].clientX, dy = e.touches[0].clientY - e.touches[1].clientY; lastDist = Math.sqrt(dx*dx + dy*dy); } }, { passive: true });
      container.addEventListener('touchmove', e => { if (e.touches.length === 2) { const dx = e.touches[0].clientX - e.touches[1].clientX, dy = e.touches[0].clientY - e.touches[1].clientY, dist = Math.sqrt(dx*dx + dy*dy); if (lastDist > 0) setZoom(state.zoom + (dist - lastDist) * 0.004); lastDist = dist; } }, { passive: true });
      container.addEventListener('touchend', () => { lastDist = 0; });
    }

    async function exportPNG() {
      showToast('Exporting...');
      const exportContainer = document.getElementById('exportContainer');
      const diagramClone = document.getElementById('diagramContainer').cloneNode(true);
      diagramClone.style.cssText = 'position:relative;width:1600px;height:1000px;';
      diagramClone.querySelectorAll('.control-handle, .diagram-controls, .zoom-indicator, .empty-state, .diagram-toolbar, .story-selector').forEach(el => el.remove());
      const stepsSection = document.createElement('div');
      stepsSection.style.cssText = 'border-top:2px solid #e2e8f0;padding:20px;width:1600px;background:white;';
      stepsSection.innerHTML = document.getElementById('stepsContainer').innerHTML;
      exportContainer.innerHTML = '';
      exportContainer.style.cssText = 'position:absolute;left:0;top:0;width:1640px;background:white;padding:20px;';
      exportContainer.appendChild(diagramClone);
      exportContainer.appendChild(stepsSection);
      await new Promise(r => setTimeout(r, 100));
      try {
        const canvas = await html2canvas(exportContainer, { backgroundColor: '#ffffff', scale: 2 });
        const link = document.createElement('a'); link.download = 'domain-story.png'; link.href = canvas.toDataURL('image/png'); link.click();
        showToast('Exported!');
      } catch (e) { showToast('Export failed'); }
      exportContainer.style.left = '-9999px';
    }

    function update() {
      const input = document.getElementById('storyInput').value;
      const { domains, errors } = parseDomainStory(input);
      state.domains = domains;
      state.errors = errors;
      if (state.currentDomain >= state.domains.length) state.currentDomain = -1;
      updateVisibleDomain();
      renderStorySelector();
      validate();
      document.getElementById('emptyState').style.display = Object.keys(state.participants).length ? 'none' : 'flex';
    }

    function switchTab(id) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
      document.querySelector(`.tab[data-panel="${id}"]`)?.classList.add('active');
      document.getElementById(`${id}-panel`).classList.add('active');
      if (id === 'diagram') setTimeout(fitToScreen, 80);
    }
    function showToast(msg) { document.querySelector('.toast')?.remove(); const t = document.createElement('div'); t.className = 'toast'; t.textContent = msg; document.body.appendChild(t); setTimeout(() => t.remove(), 2500); }
    function insertAtCursor(text) { const ed = document.getElementById('storyInput'), pos = ed.selectionStart; ed.value = ed.value.slice(0, pos) + text + ed.value.slice(ed.selectionEnd); ed.selectionStart = ed.selectionEnd = pos + text.length; ed.focus(); saveHistory(); update(); }
    
    function openTemplates() {
      document.getElementById('templatesModal').classList.add('active');
      document.getElementById('templateGrid').innerHTML = TEMPLATES.map(t => `<div class="template-card" data-id="${t.id}"><h4><span class="material-icons">${t.icon}</span> ${t.title}</h4><p>${t.desc}</p></div>`).join('');
      document.querySelectorAll('.template-card').forEach(card => card.onclick = () => {
        const tmpl = TEMPLATES.find(t => t.id === card.dataset.id);
        document.getElementById('storyInput').value = tmpl.content;
        saveHistory(); update();
        document.getElementById('templatesModal').classList.remove('active');
        showToast('Template loaded!');
      });
    }

    function handleEditorKeys(e) {
      const ac = document.getElementById('autocomplete');
      if (!ac.classList.contains('visible')) {
        if ((e.ctrlKey || e.metaKey) && e.key === 'z') { e.preventDefault(); undo(); }
        if ((e.ctrlKey || e.metaKey) && e.key === 'y') { e.preventDefault(); redo(); }
        return;
      }
      const items = ac.querySelectorAll('.autocomplete-item');
      if (e.key === 'ArrowDown') { e.preventDefault(); autocompleteIndex = Math.min(autocompleteIndex + 1, items.length - 1); }
      else if (e.key === 'ArrowUp') { e.preventDefault(); autocompleteIndex = Math.max(autocompleteIndex - 1, 0); }
      else if (e.key === 'Enter' && autocompleteIndex >= 0) { e.preventDefault(); items[autocompleteIndex]?.click(); }
      else if (e.key === 'Escape') hideAutocomplete();
      items.forEach((it, i) => it.classList.toggle('selected', i === autocompleteIndex));
    }
    
    function showAutocomplete(items, x, y) {
      const ac = document.getElementById('autocomplete');
      if (!items.length) { ac.classList.remove('visible'); return; }
      ac.innerHTML = items.map((item, i) => `<div class="autocomplete-item ${i === autocompleteIndex ? 'selected' : ''}" data-value="${item.value}"><span class="material-icons">${item.icon}</span><span class="autocomplete-item-name">${item.name}</span></div>`).join('');
      ac.style.left = `${Math.min(x, window.innerWidth - 180)}px`; ac.style.top = `${Math.min(y + 20, window.innerHeight - 220)}px`; ac.classList.add('visible');
      ac.querySelectorAll('.autocomplete-item').forEach(item => item.addEventListener('click', () => insertAutocomplete(item.dataset.value)));
    }
    function hideAutocomplete() { document.getElementById('autocomplete').classList.remove('visible'); autocompleteIndex = -1; }
    function insertAutocomplete(value) { const ed = document.getElementById('storyInput'), pos = ed.selectionStart, text = ed.value; let start = pos; while (start > 0 && !/[\n\s(,]/.test(text[start - 1])) start--; ed.value = text.slice(0, start) + value + text.slice(pos); ed.selectionStart = ed.selectionEnd = start + value.length; ed.focus(); hideAutocomplete(); update(); }
    function checkAutocomplete() {
      const ed = document.getElementById('storyInput'), pos = ed.selectionStart, text = ed.value, lineStart = text.lastIndexOf('\n', pos - 1) + 1, line = text.slice(lineStart, pos);
      const iconM = line.match(/\((\w*)$/);
      if (iconM) { const s = iconM[1].toLowerCase(), icons = (s ? ICON_CATEGORIES.suggested.filter(i => i.includes(s)) : ICON_CATEGORIES.suggested).slice(0, 6); if (icons.length) { const rect = ed.getBoundingClientRect(); showAutocomplete(icons.map(i => ({ icon: i, name: i, value: i + ')' })), rect.left + 10, rect.top + 50); return; } }
      hideAutocomplete();
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
