<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Domain Storytelling</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --primary-light: #e0e7ff;
      --surface: #ffffff;
      --surface-dim: #f8fafc;
      --surface-alt: #f1f5f9;
      --border: #e2e8f0;
      --text: #1e293b;
      --text-muted: #64748b;
      --text-light: #94a3b8;
      --success: #10b981;
      --success-light: #d1fae5;
      --warning: #f59e0b;
      --warning-light: #fef3c7;
      --danger: #ef4444;
      --danger-light: #fee2e2;
      --radius: 12px;
      --radius-sm: 8px;
      --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    }
    .dark {
      --primary: #818cf8;
      --primary-dark: #6366f1;
      --primary-light: #312e81;
      --surface: #1e293b;
      --surface-dim: #0f172a;
      --surface-alt: #334155;
      --border: #475569;
      --text: #f1f5f9;
      --text-muted: #94a3b8;
      --text-light: #64748b;
      --success-light: #064e3b;
      --warning-light: #78350f;
      --danger-light: #7f1d1d;
    }
    .dark .participant { background: var(--surface-alt); }
    .dark .flow-label-bg { fill: var(--surface-alt); stroke: var(--border); }
    .dark .domain-note { background: #422006; border-color: #854d0e; color: #fef3c7; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--surface-dim);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }
    
    .app { display: flex; flex-direction: column; height: 100vh; height: 100dvh; }
    
    .header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 10px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      flex-shrink: 0;
    }
    .header h1 { font-size: 17px; font-weight: 600; display: flex; align-items: center; gap: 6px; }
    .header h1 .material-icons { color: var(--primary); font-size: 22px; }
    .header-actions { display: flex; gap: 4px; }
    
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 10px 16px;
      border: none;
      border-radius: var(--radius);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
      -webkit-tap-highlight-color: transparent;
      background: var(--surface);
      color: var(--text);
    }
    .btn-icon { width: 38px; height: 38px; padding: 0; border-radius: 10px; }
    .btn-sm { padding: 6px 10px; font-size: 13px; border-radius: var(--radius-sm); }
    .btn-sm .material-icons { font-size: 16px; }
    .btn-xs { padding: 4px 8px; font-size: 11px; border-radius: 6px; }
    .btn-xs .material-icons { font-size: 14px; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-dark); }
    .btn-secondary { background: var(--surface); color: var(--text); border: 1px solid var(--border); }
    .btn-secondary:hover { background: var(--surface-dim); }
    .btn-ghost { background: transparent; color: var(--text-muted); }
    .btn-ghost:hover { background: var(--surface-alt); color: var(--text); }
    .btn .material-icons { font-size: 20px; }
    .btn:active { transform: scale(0.97); }
    
    .tabs {
      display: flex;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }
    .tab {
      flex: 1;
      padding: 11px 12px;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-muted);
      background: none;
      border: none;
      cursor: pointer;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
    }
    .tab.active { color: var(--primary); }
    .tab.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 12px;
      right: 12px;
      height: 2px;
      background: var(--primary);
      border-radius: 2px 2px 0 0;
    }
    .tab .material-icons { font-size: 18px; }
    .tab-badge { background: var(--danger); color: white; font-size: 10px; min-width: 18px; height: 18px; padding: 0 5px; border-radius: 9px; display: inline-flex; align-items: center; justify-content: center; margin-left: 4px; }
    
    .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    .panel { flex: 1; overflow: hidden; display: none; flex-direction: column; }
    .panel.active { display: flex; }
    
    .editor-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    .editor-toolbar {
      padding: 6px 10px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      display: flex;
      gap: 4px;
      overflow-x: auto;
      align-items: center;
      flex-shrink: 0;
    }
    .toolbar-divider { width: 1px; height: 24px; background: var(--border); margin: 0 4px; flex-shrink: 0; }
    .editor-wrapper { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
    .editor {
      flex: 1;
      padding: 14px;
      font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
      font-size: 14px;
      line-height: 1.65;
      border: none;
      resize: none;
      background: var(--surface);
      color: var(--text);
    }
    .editor:focus { outline: none; }
    .editor::placeholder { color: var(--text-light); }
    
    .validation-bar {
      padding: 8px 14px;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
      border-top: 1px solid var(--border);
      background: var(--surface);
      flex-shrink: 0;
    }
    .validation-bar.success { background: var(--success-light); color: #065f46; }
    .dark .validation-bar.success { color: #6ee7b7; }
    .validation-bar.error { background: var(--danger-light); color: #991b1b; }
    .dark .validation-bar.error { color: #fca5a5; }
    .validation-bar .material-icons { font-size: 16px; }
    .validation-bar code { background: rgba(0,0,0,0.1); padding: 1px 4px; border-radius: 3px; font-family: monospace; font-size: 11px; }
    
    .autocomplete {
      position: absolute;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow-lg);
      max-height: 200px;
      overflow-y: auto;
      z-index: 50;
      display: none;
      min-width: 160px;
    }
    .autocomplete.visible { display: block; }
    .autocomplete-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
    }
    .autocomplete-item:last-child { border-bottom: none; }
    .autocomplete-item:hover, .autocomplete-item.selected { background: var(--primary-light); }
    .autocomplete-item .material-icons { font-size: 20px; color: var(--primary); }
    .autocomplete-item-name { font-size: 13px; font-weight: 500; }
    
    .quick-bar {
      padding: 8px 10px;
      background: var(--surface-alt);
      border-top: 1px solid var(--border);
      display: flex;
      gap: 6px;
      overflow-x: auto;
      flex-shrink: 0;
    }
    .quick-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 8px 12px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      font-size: 13px;
      cursor: pointer;
      white-space: nowrap;
    }
    .quick-chip:hover { background: var(--primary-light); border-color: var(--primary); }
    .quick-chip .material-icons { font-size: 16px; color: var(--primary); }
    
    .diagram-container { flex: 1; overflow: hidden; position: relative; background: var(--surface); }
    .diagram-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; touch-action: none; }
    .diagram-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
    
    .participant {
      position: absolute;
      background: var(--surface);
      border: 2px solid var(--border);
      border-radius: var(--radius);
      padding: 10px 8px;
      text-align: center;
      cursor: move;
      touch-action: none;
      user-select: none;
      box-shadow: var(--shadow);
      min-width: 80px;
      max-width: 120px;
      transition: box-shadow 0.15s, border-color 0.15s;
    }
    .participant:hover { box-shadow: var(--shadow-lg); }
    .participant.dragging { box-shadow: var(--shadow-lg); border-color: var(--primary); z-index: 10; }
    .participant .material-icons { font-size: 28px; margin-bottom: 4px; }
    .participant-name { font-size: 11px; font-weight: 600; word-wrap: break-word; line-height: 1.25; }
    .participant-annotation { font-size: 9px; color: var(--text-muted); margin-top: 3px; font-style: italic; }
    .participant[data-type="person"] { border-color: #c7d2fe; }
    .participant[data-type="person"] .material-icons { color: #6366f1; }
    .participant[data-type="system"] { border-color: #a7f3d0; }
    .participant[data-type="system"] .material-icons { color: #10b981; }
    .participant[data-type="document"] { border-color: #fde68a; }
    .participant[data-type="document"] .material-icons { color: #f59e0b; }
    .participant[data-type="work"] { border-color: #fbcfe8; }
    .participant[data-type="work"] .material-icons { color: #ec4899; }
    .participant.highlighted { border-color: var(--primary) !important; box-shadow: 0 0 0 3px var(--primary-light), var(--shadow-lg); }
    
    .diagram-toolbar {
      position: absolute;
      top: 12px;
      left: 12px;
      display: flex;
      gap: 6px;
      z-index: 50;
      flex-wrap: wrap;
      max-width: calc(100% - 80px);
    }
    .diagram-toolbar .btn { box-shadow: var(--shadow); }
    .layout-dropdown { position: relative; }
    .layout-menu {
      position: absolute;
      top: 100%;
      left: 0;
      margin-top: 4px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow-lg);
      min-width: 160px;
      display: none;
      z-index: 100;
    }
    .layout-menu.visible { display: block; }
    .layout-menu-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      cursor: pointer;
      font-size: 13px;
      border-bottom: 1px solid var(--border);
    }
    .layout-menu-item:last-child { border-bottom: none; }
    .layout-menu-item:hover { background: var(--primary-light); }
    .layout-menu-item .material-icons { font-size: 18px; color: var(--primary); }
    
    /* Domain Story Selector */
    .story-selector {
      position: absolute;
      top: 12px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      align-items: center;
      gap: 4px;
      background: var(--surface);
      padding: 4px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      z-index: 50;
      max-width: calc(100% - 200px);
      overflow-x: auto;
    }
    .story-tab {
      padding: 8px 14px;
      font-size: 12px;
      font-weight: 500;
      border-radius: var(--radius-sm);
      cursor: pointer;
      white-space: nowrap;
      background: transparent;
      color: var(--text-muted);
      border: none;
      transition: all 0.15s;
    }
    .story-tab:hover { background: var(--surface-alt); color: var(--text); }
    .story-tab.active { background: var(--primary); color: white; }
    .story-tab-all { font-style: italic; }
    
    .diagram-controls {
      position: absolute;
      bottom: 16px;
      right: 16px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      z-index: 50;
    }
    .diagram-controls .btn { box-shadow: var(--shadow); width: 42px; height: 42px; }
    .zoom-indicator {
      position: absolute;
      top: 12px;
      right: 12px;
      background: var(--surface);
      padding: 5px 10px;
      border-radius: 16px;
      font-size: 11px;
      font-weight: 600;
      box-shadow: var(--shadow);
      z-index: 50;
    }
    
    .flow-path { fill: none; stroke-width: 2; stroke-linecap: round; }
    .flow-label { font-size: 10px; font-weight: 500; fill: var(--text); }
    .flow-label-bg { fill: var(--surface); stroke: var(--border); stroke-width: 1; }
    .step-badge { font-size: 9px; font-weight: 700; fill: white; }
    .annotation-box { fill: #fef3c7; stroke: #fbbf24; stroke-width: 1; }
    .annotation-text { font-size: 9px; fill: #92400e; }
    .work-object-box { fill: #fce7f3; stroke: #ec4899; stroke-width: 1.5; }
    .work-object-text { font-size: 9px; font-weight: 500; fill: #be185d; }
    .control-handle { fill: var(--danger); stroke: white; stroke-width: 2; cursor: move; pointer-events: all; opacity: 0.8; }
    .hide-handles .control-handle { display: none; }
    
    .steps-container { flex: 1; overflow-y: auto; padding: 14px; }
    
    /* Domain Notes */
    .domain-header {
      background: var(--primary);
      color: white;
      padding: 14px 16px;
      margin: -14px -14px 14px -14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .domain-header h2 { font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
    .domain-header h2 .material-icons { font-size: 20px; }
    .domain-notes-section { margin-bottom: 20px; }
    .domain-notes-title { font-size: 13px; font-weight: 600; color: var(--text-muted); margin-bottom: 8px; display: flex; align-items: center; gap: 6px; }
    .domain-notes-title .material-icons { font-size: 16px; }
    .domain-note {
      background: #fffbeb;
      border: 1px solid #fcd34d;
      border-left: 4px solid #f59e0b;
      border-radius: var(--radius-sm);
      padding: 10px 12px;
      margin-bottom: 8px;
      font-size: 13px;
      line-height: 1.5;
    }
    .domain-note-tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      color: #92400e;
      margin-bottom: 4px;
    }
    .domain-note-tag .material-icons { font-size: 14px; }
    .domain-note-tag.user-story { color: #1d4ed8; }
    .domain-note-tag.requirement { color: #7c3aed; }
    .domain-note-tag.assumption { color: #0891b2; }
    .domain-note-tag.risk { color: #dc2626; }
    .domain-note-content { color: var(--text); }
    
    .flow-section { margin-bottom: 20px; }
    .flow-header { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
    .flow-badge { width: 26px; height: 26px; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: 600; }
    .flow-title { font-size: 15px; font-weight: 600; }
    .step-item { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 10px 12px; margin-bottom: 6px; font-size: 13px; cursor: pointer; transition: all 0.15s; }
    .step-item:hover { border-color: var(--primary); background: var(--primary-light); }
    .step-header { display: flex; align-items: flex-start; gap: 8px; }
    .step-number { display: inline-flex; align-items: center; justify-content: center; min-width: 20px; height: 20px; padding: 0 5px; background: var(--text-muted); color: white; border-radius: 5px; font-size: 10px; font-weight: 600; flex-shrink: 0; }
    .step-content { flex: 1; line-height: 1.4; }
    .step-actors strong { color: var(--primary); }
    .step-action { color: var(--text-muted); }
    .step-work-object { display: inline-flex; align-items: center; gap: 3px; background: #fce7f3; color: #be185d; padding: 1px 6px; border-radius: 4px; font-size: 11px; margin-left: 4px; }
    .step-annotation { margin-top: 6px; padding: 6px 10px; background: #fef3c7; border-radius: 6px; font-size: 11px; color: #92400e; }
    
    .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 30px; text-align: center; color: var(--text-muted); }
    .empty-state .material-icons { font-size: 56px; margin-bottom: 12px; opacity: 0.4; }
    .empty-state p { font-size: 14px; margin-bottom: 16px; }
    
    .search-bar {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
    }
    .search-input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 14px;
      background: var(--surface-dim);
      color: var(--text);
    }
    .search-input:focus { outline: none; border-color: var(--primary); }
    .search-input::placeholder { color: var(--text-light); }
    .search-results { font-size: 12px; color: var(--text-muted); white-space: nowrap; }
    
    .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); z-index: 200; display: none; align-items: flex-end; justify-content: center; }
    .modal-overlay.active { display: flex; }
    .modal { background: var(--surface); border-radius: 20px 20px 0 0; width: 100%; max-width: 560px; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column; animation: slideUp 0.25s ease; }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    .modal-header { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
    .modal-header h2 { font-size: 17px; }
    .modal-body { flex: 1; overflow-y: auto; padding: 16px 20px; }
    .modal-tabs { display: flex; gap: 4px; margin-bottom: 16px; background: var(--surface-alt); padding: 4px; border-radius: var(--radius); }
    .modal-tab { flex: 1; padding: 8px 10px; font-size: 12px; font-weight: 500; background: none; border: none; border-radius: var(--radius-sm); cursor: pointer; color: var(--text-muted); }
    .modal-tab.active { background: var(--surface); color: var(--text); box-shadow: var(--shadow); }
    .modal-panel { display: none; }
    .modal-panel.active { display: block; }
    .syntax-block { background: var(--surface-dim); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 12px; font-family: 'SF Mono', 'Fira Code', monospace; font-size: 12px; line-height: 1.55; overflow-x: auto; margin: 10px 0; white-space: pre-wrap; }
    .syntax-section { margin-bottom: 18px; }
    .syntax-section h3 { font-size: 13px; font-weight: 600; margin-bottom: 6px; display: flex; align-items: center; gap: 5px; }
    .syntax-section h3 .material-icons { font-size: 16px; color: var(--primary); }
    .syntax-section p { font-size: 12px; color: var(--text-muted); margin-bottom: 6px; }
    .llm-prompt-box { position: relative; background: var(--surface-dim); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 12px; padding-top: 44px; font-size: 11px; line-height: 1.5; max-height: 280px; overflow-y: auto; font-family: 'SF Mono', monospace; }
    .copy-btn-float { position: absolute; top: 8px; right: 8px; }
    .template-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
    .template-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 12px; cursor: pointer; transition: all 0.15s; }
    .template-card:hover { border-color: var(--primary); background: var(--primary-light); }
    .template-card h4 { font-size: 13px; margin-bottom: 4px; display: flex; align-items: center; gap: 6px; }
    .template-card h4 .material-icons { font-size: 18px; color: var(--primary); }
    .template-card p { font-size: 11px; color: var(--text-muted); }
    
    .shortcuts-grid { display: grid; grid-template-columns: auto 1fr; gap: 8px 16px; }
    .shortcut-key { display: inline-flex; align-items: center; gap: 4px; }
    .shortcut-key kbd { background: var(--surface-dim); border: 1px solid var(--border); border-radius: 4px; padding: 2px 6px; font-family: monospace; font-size: 11px; }
    .shortcut-desc { font-size: 13px; color: var(--text-muted); }
    
    .icon-picker-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); z-index: 200; display: none; align-items: flex-end; }
    .icon-picker-overlay.active { display: flex; }
    .icon-picker { background: var(--surface); border-radius: 20px 20px 0 0; width: 100%; max-height: 65vh; display: flex; flex-direction: column; animation: slideUp 0.25s ease; }
    .icon-picker-header { padding: 14px; border-bottom: 1px solid var(--border); flex-shrink: 0; }
    .icon-picker-header h3 { font-size: 15px; margin-bottom: 10px; }
    .icon-search { width: 100%; padding: 10px 14px; border: 1px solid var(--border); border-radius: var(--radius-sm); font-size: 15px; background: var(--surface-dim); color: var(--text); }
    .icon-search:focus { outline: none; border-color: var(--primary); }
    .icon-categories { display: flex; gap: 5px; margin-top: 10px; flex-wrap: wrap; }
    .icon-category { padding: 5px 10px; font-size: 11px; background: var(--surface-alt); border: 1px solid var(--border); border-radius: 14px; cursor: pointer; }
    .icon-category.active { background: var(--primary); color: white; border-color: var(--primary); }
    .icon-grid { flex: 1; overflow-y: auto; padding: 12px; display: grid; grid-template-columns: repeat(auto-fill, minmax(72px, 1fr)); gap: 6px; }
    .icon-item { display: flex; flex-direction: column; align-items: center; padding: 10px 4px; border-radius: var(--radius-sm); cursor: pointer; text-align: center; border: 1px solid transparent; }
    .icon-item:hover { background: var(--primary-light); border-color: var(--primary); }
    .icon-item .material-icons { font-size: 26px; color: var(--text); margin-bottom: 3px; }
    .icon-item span:last-child { font-size: 9px; color: var(--text-muted); word-break: break-all; line-height: 1.15; }
    
    .toast { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); background: var(--text); color: var(--surface); padding: 10px 20px; border-radius: 20px; font-size: 13px; z-index: 300; animation: fadeInUp 0.2s ease; box-shadow: var(--shadow-lg); }
    @keyframes fadeInUp { from { opacity: 0; transform: translateX(-50%) translateY(16px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
    
    .save-indicator { display: flex; align-items: center; gap: 4px; font-size: 11px; color: var(--text-muted); margin-left: auto; }
    .save-indicator .material-icons { font-size: 14px; }
    .save-indicator.saving { color: var(--warning); }
    .save-indicator.saved { color: var(--success); }
    
    @media (min-width: 900px) {
      .tabs { display: none; }
      .main-content { flex-direction: row; }
      .panel.editor-panel { display: flex !important; width: 360px; min-width: 300px; max-width: 450px; border-right: 1px solid var(--border); resize: horizontal; overflow: auto; }
      .panel.diagram-panel { display: flex !important; flex: 1; flex-direction: column; }
      .panel.steps-panel { display: none !important; }
      .desktop-steps-section { border-top: 1px solid var(--border); max-height: 280px; overflow-y: auto; background: var(--surface-dim); }
      .desktop-steps-section .steps-container { padding: 12px 16px; }
      .desktop-steps-section .flow-section { margin-bottom: 12px; }
      .desktop-steps-section .step-item { padding: 8px 10px; margin-bottom: 4px; }
      .desktop-steps-section .domain-header { margin: -12px -16px 12px -16px; padding: 10px 16px; }
      .steps-toggle { display: flex; align-items: center; justify-content: space-between; padding: 8px 16px; background: var(--surface); border-bottom: 1px solid var(--border); cursor: pointer; font-size: 13px; font-weight: 500; color: var(--text-muted); }
      .steps-toggle:hover { background: var(--surface-dim); }
      .steps-toggle .material-icons { font-size: 20px; transition: transform 0.2s; }
      .steps-toggle.collapsed .material-icons { transform: rotate(180deg); }
      .modal { border-radius: 20px; max-height: 70vh; margin: auto; }
      .icon-picker { border-radius: 20px; max-height: 55vh; max-width: 480px; margin: auto; }
    }
    @media (min-width: 1200px) {
      .panel.editor-panel { width: 420px; }
      .desktop-steps-section { max-height: 320px; }
    }
    
    .measure-svg { position: absolute; visibility: hidden; pointer-events: none; }
    .export-container { position: absolute; left: -9999px; top: 0; background: white; padding: 20px; }
  </style>
</head>
<body>
  <div class="app">
    <header class="header">
      <h1><span class="material-icons">account_tree</span>Domain Story</h1>
      <div class="header-actions">
        <span class="save-indicator saved" id="saveIndicator"><span class="material-icons">cloud_done</span> Saved</span>
        <button class="btn btn-ghost btn-icon" id="darkModeBtn" title="Toggle dark mode"><span class="material-icons">dark_mode</span></button>
        <button class="btn btn-ghost btn-icon" id="shortcutsBtn" title="Keyboard shortcuts"><span class="material-icons">keyboard</span></button>
        <button class="btn btn-ghost btn-icon" id="templatesBtn" title="Templates"><span class="material-icons">dashboard</span></button>
        <button class="btn btn-ghost btn-icon" id="helpBtn" title="Help"><span class="material-icons">help_outline</span></button>
        <button class="btn btn-secondary btn-icon" id="iconPickerBtn" title="Icons"><span class="material-icons">emoji_symbols</span></button>
        <button class="btn btn-primary btn-icon" id="exportBtn" title="Export"><span class="material-icons">download</span></button>
      </div>
    </header>
    
    <nav class="tabs">
      <button class="tab active" data-panel="editor"><span class="material-icons">edit_note</span>Edit<span class="tab-badge" id="errorBadge" style="display:none">0</span></button>
      <button class="tab" data-panel="diagram"><span class="material-icons">schema</span>Diagram</button>
      <button class="tab" data-panel="steps"><span class="material-icons">list</span>Steps</button>
    </nav>
    
    <div class="main-content">
      <section class="panel editor-panel active" id="editor-panel">
        <div class="editor-container">
          <div class="editor-toolbar">
            <button class="btn btn-ghost btn-sm" id="undoBtn" title="Undo (Ctrl+Z)"><span class="material-icons">undo</span></button>
            <button class="btn btn-ghost btn-sm" id="redoBtn" title="Redo (Ctrl+Y)"><span class="material-icons">redo</span></button>
            <span class="toolbar-divider"></span>
            <button class="btn btn-ghost btn-sm" id="insertDomainBtn" title="Add Domain Story"><span class="material-icons">library_add</span></button>
            <button class="btn btn-ghost btn-sm" id="insertActorBtn" title="Add Actor"><span class="material-icons">person_add</span></button>
            <button class="btn btn-ghost btn-sm" id="insertFlowBtn" title="Add Flow"><span class="material-icons">playlist_add</span></button>
            <button class="btn btn-ghost btn-sm" id="insertNoteBtn" title="Add Note"><span class="material-icons">note_add</span></button>
            <span class="toolbar-divider"></span>
            <button class="btn btn-ghost btn-sm" id="shareBtn" title="Share Link"><span class="material-icons">share</span></button>
            <button class="btn btn-ghost btn-sm" id="importBtn" title="Import JSON"><span class="material-icons">upload_file</span></button>
            <button class="btn btn-ghost btn-sm" id="exportJsonBtn" title="Export JSON"><span class="material-icons">download</span></button>
            <span class="toolbar-divider"></span>
            <button class="btn btn-ghost btn-sm" id="clearBtn" title="Clear"><span class="material-icons">delete_outline</span></button>
          </div>
          <div class="editor-wrapper">
            <textarea class="editor" id="storyInput" placeholder="Write your domain stories...

# As-Is Process
> [user-story] As a user I want to...
> [requirement] System must...

@Customer (person)
@System (computer)

## Main Flow
Customer, interacts with, System"></textarea>
            <div class="autocomplete" id="autocomplete"></div>
          </div>
          <div class="validation-bar" id="validationBar">
            <span class="material-icons">check_circle</span>
            <span id="validationText">Ready</span>
          </div>
          <div class="quick-bar">
            <span class="quick-chip" data-action="domain"><span class="material-icons">library_add</span> Domain</span>
            <span class="quick-chip" data-action="actor"><span class="material-icons">person_add</span> Actor</span>
            <span class="quick-chip" data-action="flow"><span class="material-icons">arrow_forward</span> Flow</span>
            <span class="quick-chip" data-action="step"><span class="material-icons">add</span> Step</span>
            <span class="quick-chip" data-action="userstory"><span class="material-icons">auto_stories</span> Story</span>
            <span class="quick-chip" data-action="requirement"><span class="material-icons">checklist</span> Req</span>
          </div>
        </div>
      </section>
      
      <section class="panel diagram-panel" id="diagram-panel">
        <div class="diagram-container" id="diagramContainer">
          <div class="diagram-canvas" id="diagramCanvas"></div>
          <svg class="diagram-svg" id="diagramSvg"></svg>
          
          <div class="diagram-toolbar">
            <div class="layout-dropdown">
              <button class="btn btn-secondary btn-sm" id="layoutBtn" title="Auto-layout"><span class="material-icons">auto_fix_high</span> Layout</button>
              <div class="layout-menu" id="layoutMenu">
                <div class="layout-menu-item" data-layout="flow"><span class="material-icons">arrow_forward</span> Flow (Left→Right)</div>
                <div class="layout-menu-item" data-layout="circular"><span class="material-icons">radio_button_unchecked</span> Circular</div>
                <div class="layout-menu-item" data-layout="force"><span class="material-icons">hub</span> Force-Directed</div>
                <div class="layout-menu-item" data-layout="grid"><span class="material-icons">grid_view</span> Grid</div>
              </div>
            </div>
          </div>
          
          <div class="story-selector" id="storySelector"></div>
          
          <div class="zoom-indicator" id="zoomIndicator">100%</div>
          
          <div class="diagram-controls">
            <button class="btn btn-secondary btn-icon" id="zoomInBtn"><span class="material-icons">add</span></button>
            <button class="btn btn-secondary btn-icon" id="zoomOutBtn"><span class="material-icons">remove</span></button>
            <button class="btn btn-secondary btn-icon" id="fitBtn"><span class="material-icons">fit_screen</span></button>
          </div>
          
          <div class="empty-state" id="emptyState">
            <span class="material-icons">draw</span>
            <p>Your diagram will appear here</p>
            <button class="btn btn-primary" id="startEditingBtn">Start Editing</button>
          </div>
        </div>
        
        <div class="desktop-steps-section" id="desktopSteps" style="display:none">
          <div class="steps-toggle" id="stepsToggle">
            <span>Steps & Notes</span>
            <span class="material-icons">expand_less</span>
          </div>
          <div class="steps-container" id="desktopStepsContainer"></div>
        </div>
      </section>
      
      <section class="panel steps-panel" id="steps-panel">
        <div class="search-bar">
          <input type="text" class="search-input" id="mobileSearchInput" placeholder="Search..." />
          <span class="search-results" id="mobileSearchResults"></span>
        </div>
        <div class="steps-container" id="stepsContainer">
          <div class="empty-state"><span class="material-icons">format_list_numbered</span><p>Steps will appear here</p></div>
        </div>
      </section>
    </div>
  </div>
  
  <div class="export-container" id="exportContainer"></div>
  
  <!-- Help Modal -->
  <div class="modal-overlay" id="helpModal">
    <div class="modal">
      <div class="modal-header"><h2>How to Use</h2><button class="btn btn-icon btn-ghost" id="closeHelpBtn"><span class="material-icons">close</span></button></div>
      <div class="modal-body">
        <div class="modal-tabs">
          <button class="modal-tab active" data-tab="syntax">Syntax</button>
          <button class="modal-tab" data-tab="groups">Groups</button>
          <button class="modal-tab" data-tab="llm">For AI</button>
        </div>
        <div class="modal-panel active" id="syntax-panel">
          <div class="syntax-section"><h3><span class="material-icons">folder</span> Domain Story Groups</h3><p>Use # to create groups (e.g., As-Is, To-Be)</p><div class="syntax-block"># Incident Record As-Is
# Incident Record To-Be Release 1
# Incident Record To-Be Release 2</div></div>
          <div class="syntax-section"><h3><span class="material-icons">sticky_note_2</span> Notes & Requirements</h3><p>Use > with tags for notes</p><div class="syntax-block">> [user-story] As a user I want to...
> [requirement] System must support...
> [assumption] We assume that...
> [risk] There is a risk that...</div></div>
          <div class="syntax-section"><h3><span class="material-icons">person</span> Define Actors</h3><div class="syntax-block">@Customer (person)
@System (computer) "annotation"</div></div>
          <div class="syntax-section"><h3><span class="material-icons">sync_alt</span> Flows & Steps</h3><div class="syntax-block">## Checkout Process
Customer, adds item to, Cart {Product}
Cart, confirms to, Customer "success"</div></div>
        </div>
        <div class="modal-panel" id="groups-panel">
          <div class="syntax-section"><h3><span class="material-icons">timeline</span> Evolution Over Time</h3><p>Create multiple domain stories to show how a domain evolves:</p><div class="syntax-block"># Current State (As-Is)
@LegacySystem (computer)
...

# Target State (To-Be)
@NewSystem (cloud)
...

# Intermediate Release 1
@HybridSystem (dns)
...</div></div>
          <div class="syntax-section"><h3><span class="material-icons">switch_access_shortcut</span> Switching Views</h3><p>Use the tabs above the diagram to switch between domain stories or view all at once.</p></div>
          <div class="syntax-section"><h3><span class="material-icons">note_alt</span> Attaching Context</h3><p>Add user stories, requirements, assumptions, and risks at the domain level using > notes:</p><div class="syntax-block"># Payment Integration
> [user-story] As a customer I want to pay with Apple Pay
> [requirement] PCI-DSS compliance required
> [assumption] Partner API is stable
> [risk] Integration timeline uncertain

@Customer (person)
...</div></div>
        </div>
        <div class="modal-panel" id="llm-panel">
          <p style="margin-bottom:12px;font-size:12px;color:var(--text-muted);">Copy this prompt for any AI:</p>
          <div class="llm-prompt-box" id="llmPrompt"><button class="btn btn-sm btn-secondary copy-btn-float" id="copyLlmPrompt"><span class="material-icons">content_copy</span> Copy</button></div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Shortcuts Modal -->
  <div class="modal-overlay" id="shortcutsModal">
    <div class="modal">
      <div class="modal-header"><h2>Keyboard Shortcuts</h2><button class="btn btn-icon btn-ghost" id="closeShortcutsBtn"><span class="material-icons">close</span></button></div>
      <div class="modal-body">
        <div class="shortcuts-grid">
          <div class="shortcut-key"><kbd>Ctrl</kbd>+<kbd>Z</kbd></div><div class="shortcut-desc">Undo</div>
          <div class="shortcut-key"><kbd>Ctrl</kbd>+<kbd>Y</kbd></div><div class="shortcut-desc">Redo</div>
          <div class="shortcut-key"><kbd>Ctrl</kbd>+<kbd>E</kbd></div><div class="shortcut-desc">Export PNG</div>
          <div class="shortcut-key"><kbd>Ctrl</kbd>+<kbd>L</kbd></div><div class="shortcut-desc">Auto-layout</div>
          <div class="shortcut-key"><kbd>Ctrl</kbd>+<kbd>D</kbd></div><div class="shortcut-desc">Toggle dark mode</div>
          <div class="shortcut-key"><kbd>Esc</kbd></div><div class="shortcut-desc">Close modal</div>
          <div class="shortcut-key"><kbd>←</kbd> <kbd>→</kbd></div><div class="shortcut-desc">Switch domain stories</div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Templates Modal -->
  <div class="modal-overlay" id="templatesModal">
    <div class="modal">
      <div class="modal-header"><h2>Templates</h2><button class="btn btn-icon btn-ghost" id="closeTemplatesBtn"><span class="material-icons">close</span></button></div>
      <div class="modal-body"><div class="template-grid" id="templateGrid"></div></div>
    </div>
  </div>
  
  <!-- Icon Picker -->
  <div class="icon-picker-overlay" id="iconPickerOverlay">
    <div class="icon-picker">
      <div class="icon-picker-header">
        <h3>Choose Icon</h3>
        <input type="text" class="icon-search" id="iconSearch" placeholder="Search icons..." />
        <div class="icon-categories" id="iconCategories">
          <span class="icon-category active" data-category="suggested">Suggested</span>
          <span class="icon-category" data-category="people">People</span>
          <span class="icon-category" data-category="business">Business</span>
          <span class="icon-category" data-category="tech">Tech</span>
          <span class="icon-category" data-category="docs">Docs</span>
          <span class="icon-category" data-category="all">All</span>
        </div>
      </div>
      <div class="icon-grid" id="iconGrid"></div>
    </div>
  </div>
  
  <input type="file" id="importFileInput" accept=".json" style="display:none" />
  <svg class="measure-svg" id="measureSvg"><text id="measureText" font-size="10"></text></svg>
 = document.createElementNS('http://www.w3.org/2000/svg', 'path');
          pathEl.setAttribute('d', `M ${fromE.x},${fromE.y} Q ${step.controlX},${step.controlY} ${toE.x},${toE.y}`);
          pathEl.setAttribute('stroke', color); pathEl.classList.add('flow-path'); pathEl.setAttribute('marker-end', `url(#arrow-${fi % FLOW_COLORS.length})`);
          g.appendChild(pathEl);
          
          const badgePos = bezierPoint(0.15, fromE, { x: step.controlX, y: step.controlY }, toE);
          const badgeNorm = normalize({ x: -(step.controlY - fromE.y), y: step.controlX - fromE.x });
          const badge = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
          badge.setAttribute('cx', badgePos.x + badgeNorm.x * 12); badge.setAttribute('cy', badgePos.y + badgeNorm.y * 12);
          badge.setAttribute('r', 9); badge.setAttribute('fill', color); g.appendChild(badge);
          const bt = document.createElementNS('http://www.w3.org/2000/svg', 'text');
          bt.setAttribute('x', badgePos.x + badgeNorm.x * 12); bt.setAttribute('y', badgePos.y + badgeNorm.y * 12 + 3);
          bt.setAttribute('text-anchor', 'middle'); bt.classList.add('step-badge'); bt.textContent = `${flow.number}.${si + 1}`;
          g.appendChild(bt);
          
          if (step.action) {
            const labelPos = bezierPoint(0.5, fromE, { x: step.controlX, y: step.controlY }, toE);
            const labelDeriv = bezierDerivative(0.5, fromE, { x: step.controlX, y: step.controlY }, toE);
            const labelNorm = normalize({ x: -labelDeriv.y, y: labelDeriv.x });
            const controlSide = Math.sign((step.controlX - (fromE.x + toE.x)/2) * labelNorm.x + (step.controlY - (fromE.y + toE.y)/2) * labelNorm.y);
            const lx = labelPos.x + labelNorm.x * (-controlSide * 18), ly = labelPos.y + labelNorm.y * (-controlSide * 18);
            const tm = measureText(step.action, 10);
            const bg = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            bg.setAttribute('x', lx - tm.width/2 - 5); bg.setAttribute('y', ly - 8); bg.setAttribute('width', tm.width + 10); bg.setAttribute('height', 16); bg.setAttribute('rx', 3); bg.classList.add('flow-label-bg'); g.appendChild(bg);
            const tx = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            tx.setAttribute('x', lx); tx.setAttribute('y', ly + 3); tx.setAttribute('text-anchor', 'middle'); tx.classList.add('flow-label'); tx.textContent = step.action; g.appendChild(tx);
          }
          
          if (step.workObject) {
            const woPos = bezierPoint(0.8, fromE, { x: step.controlX, y: step.controlY }, toE);
            const woNorm = normalize({ x: -(toE.y - step.controlY), y: toE.x - step.controlX });
            const wx = woPos.x + woNorm.x * 16, wy = woPos.y + woNorm.y * 16;
            const tm = measureText(step.workObject, 9);
            const r = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            r.setAttribute('x', wx - tm.width/2 - 6); r.setAttribute('y', wy - 7); r.setAttribute('width', tm.width + 12); r.setAttribute('height', 14); r.setAttribute('rx', 3); r.classList.add('work-object-box'); g.appendChild(r);
            const t = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            t.setAttribute('x', wx); t.setAttribute('y', wy + 3); t.setAttribute('text-anchor', 'middle'); t.classList.add('work-object-text'); t.textContent = step.workObject; g.appendChild(t);
          }
          
          if (step.annotation) {
            const annT = step.workObject ? 0.65 : 0.75;
            const annPos = bezierPoint(annT, fromE, { x: step.controlX, y: step.controlY }, toE);
            const annNorm = normalize({ x: -(toE.y - fromE.y), y: toE.x - fromE.x });
            const ax = annPos.x - annNorm.x * 16, ay = annPos.y - annNorm.y * 16;
            const tm = measureText(step.annotation, 9);
            const r = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            r.setAttribute('x', ax - tm.width/2 - 6); r.setAttribute('y', ay - 7); r.setAttribute('width', tm.width + 12); r.setAttribute('height', 14); r.setAttribute('rx', 3); r.classList.add('annotation-box'); g.appendChild(r);
            const t = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            t.setAttribute('x', ax); t.setAttribute('y', ay + 3); t.setAttribute('text-anchor', 'middle'); t.classList.add('annotation-text'); t.textContent = step.annotation; g.appendChild(t);
          }
          
          const handle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
          handle.setAttribute('cx', step.controlX); handle.setAttribute('cy', step.controlY); handle.setAttribute('r', 6); handle.classList.add('control-handle');
          g.appendChild(handle); makeHandleDraggable(handle, step);
          svg.appendChild(g);
        });
      });
    }

    function makeHandleDraggable(h, step) {
      let dragging = false, startX, startY, startCX, startCY;
      function onStart(e) { e.preventDefault(); e.stopPropagation(); dragging = true; const t = e.touches ? e.touches[0] : e; startX = t.clientX; startY = t.clientY; startCX = step.controlX; startCY = step.controlY; document.addEventListener('mousemove', onMove); document.addEventListener('mouseup', onEnd); document.addEventListener('touchmove', onMove, { passive: false }); document.addEventListener('touchend', onEnd); }
      function onMove(e) { if (!dragging) return; e.preventDefault(); const t = e.touches ? e.touches[0] : e; step.controlX = startCX + (t.clientX - startX) / state.zoom; step.controlY = startCY + (t.clientY - startY) / state.zoom; renderFlows(); }
      function onEnd() { dragging = false; document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onEnd); document.removeEventListener('touchmove', onMove); document.removeEventListener('touchend', onEnd); autoSave(); }
      h.style.pointerEvents = 'all'; h.addEventListener('mousedown', onStart); h.addEventListener('touchstart', onStart, { passive: false });
    }

    function getBoxEdge(p, toX, toY) { const el = p.element, w = (el?.offsetWidth || 90) / 2 + 6, h = (el?.offsetHeight || 70) / 2 + 6, dx = toX - p.x, dy = toY - p.y; if (dx === 0 && dy === 0) return { x: p.x, y: p.y }; const scale = Math.min(w / Math.abs(dx || 0.001), h / Math.abs(dy || 0.001)); return { x: p.x + dx * scale, y: p.y + dy * scale }; }
    function bezierPoint(t, p0, p1, p2) { const mt = 1 - t; return { x: mt*mt*p0.x + 2*mt*t*p1.x + t*t*p2.x, y: mt*mt*p0.y + 2*mt*t*p1.y + t*t*p2.y }; }
    function bezierDerivative(t, p0, p1, p2) { return { x: 2*(1-t)*(p1.x-p0.x) + 2*t*(p2.x-p1.x), y: 2*(1-t)*(p1.y-p0.y) + 2*t*(p2.y-p1.y) }; }
    function normalize(v) { const len = Math.sqrt(v.x*v.x + v.y*v.y) || 1; return { x: v.x/len, y: v.y/len }; }
    function measureText(text, size) { const el = document.getElementById('measureText'); el.setAttribute('font-size', size); el.textContent = text; return el.getBBox(); }

    // === STEPS ===
    function renderSteps() {
      const visible = getVisibleDomains();
      let html = '';
      
      visible.forEach((domain, di) => {
        // Domain header with notes
        html += `<div class="domain-header" style="background:${domain.color}"><h2><span class="material-icons">folder</span>${domain.title}</h2></div>`;
        
        // Notes section
        if (domain.notes.length > 0) {
          html += '<div class="domain-notes-section">';
          html += '<div class="domain-notes-title"><span class="material-icons">sticky_note_2</span> Notes & Requirements</div>';
          domain.notes.forEach(note => {
            const noteType = NOTE_TYPES[note.type] || NOTE_TYPES.note;
            html += `<div class="domain-note"><div class="domain-note-tag ${note.type}"><span class="material-icons">${noteType.icon}</span> ${noteType.label}</div><div class="domain-note-content">${note.content}</div></div>`;
          });
          html += '</div>';
        }
        
        // Flows
        const domainFlows = state.flows.filter(f => f.domainTitle === domain.title);
        domainFlows.forEach((f, fi) => {
          const color = FLOW_COLORS[fi % FLOW_COLORS.length];
          html += `<div class="flow-section"><div class="flow-header"><div class="flow-badge" style="background:${color}">${f.number}</div><div class="flow-title">${f.title}</div></div>`;
          f.steps.forEach((s, si) => {
            html += `<div class="step-item" data-from="${s.from}" data-to="${s.to}"><div class="step-header"><span class="step-number" style="background:${color}">${si + 1}</span><div class="step-content"><span class="step-actors"><strong>${s.from}</strong> → <strong>${s.to}</strong></span>${s.workObject ? `<span class="step-work-object">${s.workObject}</span>` : ''}${s.action ? `<div class="step-action">${s.action}</div>` : ''}${s.annotation ? `<div class="step-annotation">${s.annotation}</div>` : ''}</div></div></div>`;
          });
          html += '</div>';
        });
      });
      
      if (!html) html = '<div class="empty-state"><span class="material-icons">format_list_numbered</span><p>Steps will appear here</p></div>';
      
      document.getElementById('stepsContainer').innerHTML = html;
      document.getElementById('desktopStepsContainer').innerHTML = html;
      
      document.querySelectorAll('.step-item').forEach(item => {
        item.onclick = () => highlightActors(item.dataset.from, item.dataset.to);
      });
      
      const desktopSteps = document.getElementById('desktopSteps');
      if (isDesktop() && state.flows.length > 0) desktopSteps.style.display = 'block';
      else if (isDesktop()) desktopSteps.style.display = 'none';
    }
    
    function highlightActors(from, to) {
      document.querySelectorAll('.participant').forEach(el => el.classList.remove('highlighted'));
      Object.values(state.participants).forEach(p => {
        if (p.displayName === from || p.displayName === to) {
          p.element?.classList.add('highlighted');
        }
      });
      setTimeout(() => document.querySelectorAll('.participant').forEach(el => el.classList.remove('highlighted')), 2000);
    }

    function performSearch(query) {
      // Simple filter for now
      document.getElementById('mobileSearchResults').textContent = query ? 'Filtering...' : '';
    }

    // === ZOOM & PAN ===
    function setZoom(z) { state.zoom = Math.max(0.2, Math.min(2, z)); document.getElementById('zoomIndicator').textContent = `${Math.round(state.zoom * 100)}%`; renderParticipants(); renderFlows(); }
    
    function fitToScreen() {
      const ps = Object.values(state.participants);
      if (!ps.length) return;
      const rect = document.getElementById('diagramContainer').getBoundingClientRect();
      let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;
      ps.forEach(p => { minX = Math.min(minX, p.x - 70); maxX = Math.max(maxX, p.x + 70); minY = Math.min(minY, p.y - 50); maxY = Math.max(maxY, p.y + 50); });
      const w = maxX - minX, h = maxY - minY, pad = 80;
      state.zoom = Math.min((rect.width - pad*2) / w, (rect.height - pad*2) / h, 1.5);
      state.pan.x = (rect.width - w * state.zoom) / 2 - minX * state.zoom;
      state.pan.y = (rect.height - h * state.zoom) / 2 - minY * state.zoom;
      document.getElementById('zoomIndicator').textContent = `${Math.round(state.zoom * 100)}%`;
      renderParticipants(); renderFlows();
    }
    
    function setupPinchZoom() {
      let lastDist = 0;
      const container = document.getElementById('diagramContainer');
      container.addEventListener('touchstart', e => { if (e.touches.length === 2) { const dx = e.touches[0].clientX - e.touches[1].clientX, dy = e.touches[0].clientY - e.touches[1].clientY; lastDist = Math.sqrt(dx*dx + dy*dy); } }, { passive: true });
      container.addEventListener('touchmove', e => { if (e.touches.length === 2) { const dx = e.touches[0].clientX - e.touches[1].clientX, dy = e.touches[0].clientY - e.touches[1].clientY, dist = Math.sqrt(dx*dx + dy*dy); if (lastDist > 0) setZoom(state.zoom + (dist - lastDist) * 0.004); lastDist = dist; } }, { passive: true });
      container.addEventListener('touchend', () => { lastDist = 0; });
    }

    // === EXPORT / IMPORT ===
    async function exportPNG() {
      showToast('Preparing export...');
      const exportContainer = document.getElementById('exportContainer');
      const diagramContainer = document.getElementById('diagramContainer');
      
      const diagramClone = diagramContainer.cloneNode(true);
      diagramClone.style.position = 'relative';
      diagramClone.style.width = '1600px';
      diagramClone.style.height = '1000px';
      diagramClone.querySelectorAll('.control-handle, .diagram-controls, .zoom-indicator, .empty-state, .diagram-toolbar, .story-selector').forEach(el => el.remove());
      
      const stepsSection = document.createElement('div');
      stepsSection.style.cssText = 'border-top:2px solid #e2e8f0;padding:20px;width:1600px;background:white;';
      stepsSection.innerHTML = document.getElementById('stepsContainer').innerHTML;
      
      exportContainer.innerHTML = '';
      exportContainer.style.left = '0';
      exportContainer.style.width = '1640px';
      exportContainer.appendChild(diagramClone);
      exportContainer.appendChild(stepsSection);
      
      await new Promise(r => setTimeout(r, 100));
      try {
        const canvas = await html2canvas(exportContainer, { backgroundColor: '#ffffff', scale: 2 });
        const link = document.createElement('a'); link.download = 'domain-story.png'; link.href = canvas.toDataURL('image/png'); link.click();
        showToast('Exported!');
      } catch (e) { showToast('Export failed'); }
      exportContainer.style.left = '-9999px';
    }
    
    function exportJSON() {
      const data = { version: 2, text: document.getElementById('storyInput').value, positions: {}, controlPoints: {} };
      Object.entries(state.participants).forEach(([key, p]) => { data.positions[p.displayName] = { x: p.x, y: p.y }; });
      state.flows.forEach((f, fi) => f.steps.forEach((s, si) => {
        if (s.controlX !== null) data.controlPoints[`${fi}-${si}`] = { x: s.controlX, y: s.controlY };
      }));
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const link = document.createElement('a'); link.download = 'domain-story.json'; link.href = URL.createObjectURL(blob); link.click();
      showToast('Exported JSON');
    }
    
    function importJSON(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        try {
          const data = JSON.parse(ev.target.result);
          document.getElementById('storyInput').value = data.text || '';
          state.savedPositions = data.positions || {};
          state.savedControlPoints = data.controlPoints || {};
          saveHistory();
          update();
          showToast('Imported!');
        } catch (err) { showToast('Invalid JSON file'); }
      };
      reader.readAsText(file);
      e.target.value = '';
    }
    
    function shareLink() {
      const text = document.getElementById('storyInput').value;
      const encoded = btoa(encodeURIComponent(text));
      const url = `${location.origin}${location.pathname}#${encoded}`;
      navigator.clipboard.writeText(url).then(() => showToast('Link copied!')).catch(() => showToast('Failed to copy'));
    }
    
    function loadFromURL() {
      const hash = location.hash.slice(1);
      if (hash) {
        try {
          const text = decodeURIComponent(atob(hash));
          document.getElementById('storyInput').value = text;
          location.hash = '';
        } catch (e) {}
      }
    }

    // === DARK MODE ===
    function toggleDarkMode() {
      state.darkMode = !state.darkMode;
      document.body.classList.toggle('dark', state.darkMode);
      localStorage.setItem('darkMode', state.darkMode);
      document.getElementById('darkModeBtn').querySelector('.material-icons').textContent = state.darkMode ? 'light_mode' : 'dark_mode';
    }

    // === KEYBOARD ===
    function handleKeyboard(e) {
      if (e.ctrlKey || e.metaKey) {
        if (e.key === 'e') { e.preventDefault(); exportPNG(); }
        else if (e.key === 'l') { e.preventDefault(); applyLayout('flow'); }
        else if (e.key === 'd') { e.preventDefault(); toggleDarkMode(); }
      }
      if (e.key === 'Escape') {
        closeModal('helpModal'); closeModal('shortcutsModal'); closeModal('templatesModal'); closeModal('iconPickerOverlay');
      }
      // Arrow keys to switch domains
      if (e.key === 'ArrowLeft' && state.domains.length > 1 && document.activeElement.tagName !== 'TEXTAREA') {
        e.preventDefault();
        state.currentDomain = state.currentDomain <= 0 ? state.domains.length - 1 : state.currentDomain - 1;
        updateVisibleDomain();
        renderStorySelector();
      }
      if (e.key === 'ArrowRight' && state.domains.length > 1 && document.activeElement.tagName !== 'TEXTAREA') {
        e.preventDefault();
        state.currentDomain = state.currentDomain >= state.domains.length - 1 ? -1 : state.currentDomain + 1;
        updateVisibleDomain();
        renderStorySelector();
      }
    }
    
    function handleEditorKeyboard(e) {
      const ac = document.getElementById('autocomplete');
      if (!ac.classList.contains('visible')) {
        if ((e.ctrlKey || e.metaKey) && e.key === 'z') { e.preventDefault(); undo(); }
        if ((e.ctrlKey || e.metaKey) && e.key === 'y') { e.preventDefault(); redo(); }
        return;
      }
      const items = ac.querySelectorAll('.autocomplete-item');
      if (e.key === 'ArrowDown') { e.preventDefault(); autocompleteIndex = Math.min(autocompleteIndex + 1, items.length - 1); }
      else if (e.key === 'ArrowUp') { e.preventDefault(); autocompleteIndex = Math.max(autocompleteIndex - 1, 0); }
      else if (e.key === 'Enter' && autocompleteIndex >= 0) { e.preventDefault(); items[autocompleteIndex]?.click(); }
      else if (e.key === 'Escape') hideAutocomplete();
      items.forEach((it, i) => it.classList.toggle('selected', i === autocompleteIndex));
    }

    // === AUTOCOMPLETE ===
    function showAutocomplete(items, x, y) {
      const ac = document.getElementById('autocomplete');
      if (!items.length) { ac.classList.remove('visible'); return; }
      ac.innerHTML = items.map((item, i) => `<div class="autocomplete-item ${i === autocompleteIndex ? 'selected' : ''}" data-value="${item.value}"><span class="material-icons">${item.icon}</span><span class="autocomplete-item-name">${item.name}</span></div>`).join('');
      ac.style.left = `${Math.min(x, window.innerWidth - 180)}px`; ac.style.top = `${Math.min(y + 20, window.innerHeight - 220)}px`; ac.classList.add('visible');
      ac.querySelectorAll('.autocomplete-item').forEach(item => item.addEventListener('click', () => insertAutocomplete(item.dataset.value)));
    }
    function hideAutocomplete() { document.getElementById('autocomplete').classList.remove('visible'); autocompleteIndex = -1; }
    function insertAutocomplete(value) { const ed = document.getElementById('storyInput'), pos = ed.selectionStart, text = ed.value; let start = pos; while (start > 0 && !/[\n\s(,]/.test(text[start - 1])) start--; ed.value = text.slice(0, start) + value + text.slice(pos); ed.selectionStart = ed.selectionEnd = start + value.length; ed.focus(); hideAutocomplete(); update(); }
    function checkAutocomplete() {
      const ed = document.getElementById('storyInput'), pos = ed.selectionStart, text = ed.value, lineStart = text.lastIndexOf('\n', pos - 1) + 1, line = text.slice(lineStart, pos);
      const iconM = line.match(/\((\w*)$/);
      if (iconM) { const s = iconM[1].toLowerCase(), icons = (s ? ICON_CATEGORIES.suggested.filter(i => i.includes(s)) : ICON_CATEGORIES.suggested).slice(0, 6); if (icons.length) { const rect = ed.getBoundingClientRect(); showAutocomplete(icons.map(i => ({ icon: i, name: i, value: i + ')' })), rect.left + 10, rect.top + 50); return; } }
      hideAutocomplete();
    }

    // === UPDATE ===
    function update() {
      const input = document.getElementById('storyInput').value;
      const { domains, errors } = parseDomainStory(input);
      state.domains = domains;
      state.errors = errors;
      
      // Reset current domain if needed
      if (state.currentDomain >= state.domains.length) state.currentDomain = -1;
      
      updateVisibleDomain();
      renderStorySelector();
      validate();
      
      document.getElementById('emptyState').style.display = Object.keys(state.participants).length ? 'none' : 'flex';
    }

    // === UI HELPERS ===
    function switchTab(id) { document.querySelectorAll('.tab').forEach(t => t.classList.remove('active')); document.querySelectorAll('.panel').forEach(p => p.classList.remove('active')); document.querySelector(`.tab[data-panel="${id}"]`)?.classList.add('active'); document.getElementById(`${id}-panel`).classList.add('active'); if (id === 'diagram') setTimeout(fitToScreen, 80); }
    function showToast(msg) { document.querySelector('.toast')?.remove(); const t = document.createElement('div'); t.className = 'toast'; t.textContent = msg; document.body.appendChild(t); setTimeout(() => t.remove(), 2500); }
    function insertAtCursor(text) { const ed = document.getElementById('storyInput'), pos = ed.selectionStart; ed.value = ed.value.slice(0, pos) + text + ed.value.slice(ed.selectionEnd); ed.selectionStart = ed.selectionEnd = pos + text.length; ed.focus(); saveHistory(); update(); autoSave(); }
    function insertDomain() { insertAtCursor('\n# New Domain Story\n> [user-story] As a user I want...\n\n'); }
    function insertActor() { insertAtCursor('\n@NewActor (person)\n'); }
    function insertFlow() { insertAtCursor('\n## New Flow\n'); }
    function insertNote() { insertAtCursor('\n> [note] Your note here\n'); }
    function insertStep() { insertAtCursor('\nActor1, action, Actor2\n'); }
    
    function openHelp() { document.getElementById('helpModal').classList.add('active'); document.getElementById('llmPrompt').innerHTML = `<button class="btn btn-sm btn-secondary copy-btn-float" id="copyLlmPrompt"><span class="material-icons">content_copy</span> Copy</button>${LLM_PROMPT.replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>')}`; document.getElementById('copyLlmPrompt').onclick = () => { navigator.clipboard.writeText(LLM_PROMPT); showToast('Copied!'); }; }
    function openTemplates() { document.getElementById('templatesModal').classList.add('active'); document.getElementById('templateGrid').innerHTML = TEMPLATES.map(t => `<div class="template-card" data-id="${t.id}"><h4><span class="material-icons">${t.icon}</span> ${t.title}</h4><p>${t.desc}</p></div>`).join(''); document.querySelectorAll('.template-card').forEach(card => card.onclick = () => { const tmpl = TEMPLATES.find(t => t.id === card.dataset.id); document.getElementById('storyInput').value = tmpl.content; saveHistory(); update(); closeModal('templatesModal'); autoSave(); showToast('Template loaded!'); }); }
    function openIconPicker() { document.getElementById('iconPickerOverlay').classList.add('active'); document.getElementById('iconSearch').value = ''; renderIconGrid('suggested'); }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
