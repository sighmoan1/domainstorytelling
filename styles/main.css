* { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --primary: #6366f1; --primary-dark: #4f46e5; --primary-light: #e0e7ff;
  --surface: #ffffff; --surface-dim: #f8fafc; --surface-alt: #f1f5f9;
  --border: #e2e8f0; --text: #1e293b; --text-muted: #64748b; --text-light: #94a3b8;
  --success: #10b981; --success-light: #d1fae5;
  --warning: #f59e0b; --warning-light: #fef3c7;
  --danger: #ef4444; --danger-light: #fee2e2;
  --radius: 12px; --radius-sm: 8px;
  --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
}

body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--surface-dim); color: var(--text); min-height: 100vh; }
.app { display: flex; flex-direction: column; height: 100vh; height: 100dvh; }
.header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 10px 12px; display: flex; align-items: center; justify-content: space-between; gap: 8px; flex-shrink: 0; }
.header h1 { font-size: 17px; font-weight: 600; display: flex; align-items: center; gap: 6px; }
.header h1 .material-icons { color: var(--primary); font-size: 22px; }
.header-actions { display: flex; gap: 4px; }
.btn { display: inline-flex; align-items: center; justify-content: center; gap: 6px; padding: 10px 16px; border: none; border-radius: var(--radius); font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.15s; background: var(--surface); color: var(--text); }
.btn-icon { width: 38px; height: 38px; padding: 0; border-radius: 10px; }
.btn-sm { padding: 6px 10px; font-size: 13px; border-radius: var(--radius-sm); }
.btn-sm .material-icons { font-size: 16px; }
.btn-primary { background: var(--primary); color: white; }
.btn-primary:hover { background: var(--primary-dark); }
.btn-secondary { background: var(--surface); border: 1px solid var(--border); }
.btn-secondary:hover { background: var(--surface-dim); }
.btn-ghost { background: transparent; color: var(--text-muted); }
.btn-ghost:hover { background: var(--surface-alt); color: var(--text); }
.btn .material-icons { font-size: 20px; }
.btn:active { transform: scale(0.97); }
.tabs { display: flex; background: var(--surface); border-bottom: 1px solid var(--border); flex-shrink: 0; }
.tab { flex: 1; padding: 11px 12px; font-size: 13px; font-weight: 500; color: var(--text-muted); background: none; border: none; cursor: pointer; position: relative; display: flex; align-items: center; justify-content: center; gap: 5px; }
.tab.active { color: var(--primary); }
.tab.active::after { content: ''; position: absolute; bottom: 0; left: 12px; right: 12px; height: 2px; background: var(--primary); border-radius: 2px 2px 0 0; }
.tab .material-icons { font-size: 18px; }
.tab-badge { background: var(--danger); color: white; font-size: 10px; min-width: 18px; height: 18px; padding: 0 5px; border-radius: 9px; display: inline-flex; align-items: center; justify-content: center; margin-left: 4px; }
.main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
.panel { flex: 1; overflow: hidden; display: none; flex-direction: column; }
.panel.active { display: flex; }
.editor-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
.editor-toolbar { padding: 6px 10px; background: var(--surface); border-bottom: 1px solid var(--border); display: flex; gap: 4px; overflow-x: auto; align-items: center; flex-shrink: 0; }
.toolbar-divider { width: 1px; height: 24px; background: var(--border); margin: 0 4px; flex-shrink: 0; }
.editor-wrapper { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
.editor { flex: 1; padding: 14px; font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace; font-size: 14px; line-height: 1.65; border: none; resize: none; background: var(--surface); color: var(--text); }
.editor:focus { outline: none; }
.editor::placeholder { color: var(--text-light); }
.validation-bar { padding: 8px 14px; font-size: 12px; display: flex; align-items: center; gap: 6px; border-top: 1px solid var(--border); background: var(--surface); flex-shrink: 0; }
.validation-bar.success { background: var(--success-light); color: #065f46; }
.validation-bar.error { background: var(--danger-light); color: #991b1b; }
.validation-bar .material-icons { font-size: 16px; }
.validation-bar code { background: rgba(0,0,0,0.1); padding: 1px 4px; border-radius: 3px; font-family: monospace; font-size: 11px; }
.autocomplete { position: absolute; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow-lg); max-height: 200px; overflow-y: auto; z-index: 50; display: none; min-width: 160px; }
.autocomplete.visible { display: block; }
.autocomplete-item { display: flex; align-items: center; gap: 8px; padding: 10px 12px; cursor: pointer; border-bottom: 1px solid var(--border); }
.autocomplete-item:last-child { border-bottom: none; }
.autocomplete-item:hover, .autocomplete-item.selected { background: var(--primary-light); }
.autocomplete-item .material-icons { font-size: 20px; color: var(--primary); }
.quick-bar { padding: 8px 10px; background: var(--surface-alt); border-top: 1px solid var(--border); display: flex; gap: 6px; overflow-x: auto; flex-shrink: 0; }
.quick-chip { display: inline-flex; align-items: center; gap: 4px; padding: 8px 12px; background: var(--surface); border: 1px solid var(--border); border-radius: 20px; font-size: 13px; cursor: pointer; white-space: nowrap; }
.quick-chip:hover { background: var(--primary-light); border-color: var(--primary); }
.quick-chip .material-icons { font-size: 16px; color: var(--primary); }
.diagram-container { flex: 1; overflow: hidden; position: relative; background: var(--surface); }
.diagram-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; touch-action: none; }
.diagram-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
.participant { position: absolute; background: var(--surface); border: 2px solid var(--border); border-radius: var(--radius); padding: 10px 8px; text-align: center; cursor: move; touch-action: none; user-select: none; box-shadow: var(--shadow); min-width: 80px; max-width: 120px; transition: box-shadow 0.15s, border-color 0.15s; }
.participant:hover { box-shadow: var(--shadow-lg); }
.participant.dragging { box-shadow: var(--shadow-lg); border-color: var(--primary); z-index: 10; }
.participant .material-icons { font-size: 28px; margin-bottom: 4px; }
.participant-name { font-size: 11px; font-weight: 600; word-wrap: break-word; line-height: 1.25; }
.participant-annotation { font-size: 9px; color: var(--text-muted); margin-top: 3px; font-style: italic; }
.participant[data-type="person"] { border-color: #c7d2fe; }
.participant[data-type="person"] .material-icons { color: #6366f1; }
.participant[data-type="system"] { border-color: #a7f3d0; }
.participant[data-type="system"] .material-icons { color: #10b981; }
.participant[data-type="document"] { border-color: #fde68a; }
.participant[data-type="document"] .material-icons { color: #f59e0b; }
.participant[data-type="work"] { border-color: #fbcfe8; }
.participant[data-type="work"] .material-icons { color: #ec4899; }
.participant.highlighted { border-color: var(--primary) !important; box-shadow: 0 0 0 3px var(--primary-light), var(--shadow-lg); }
.diagram-toolbar { position: absolute; top: 12px; left: 12px; display: flex; gap: 6px; z-index: 50; flex-wrap: wrap; }
.diagram-toolbar .btn { box-shadow: var(--shadow); }
.layout-dropdown { position: relative; }
.layout-menu { position: absolute; top: 100%; left: 0; margin-top: 4px; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow-lg); min-width: 160px; display: none; z-index: 100; }
.layout-menu.visible { display: block; }
.layout-menu-item { display: flex; align-items: center; gap: 8px; padding: 10px 14px; cursor: pointer; font-size: 13px; border-bottom: 1px solid var(--border); }
.layout-menu-item:last-child { border-bottom: none; }
.layout-menu-item:hover { background: var(--primary-light); }
.layout-menu-item .material-icons { font-size: 18px; color: var(--primary); }
.story-selector { position: absolute; top: 12px; left: 50%; transform: translateX(-50%); display: none; align-items: center; gap: 4px; background: var(--surface); padding: 4px; border-radius: var(--radius); box-shadow: var(--shadow); z-index: 50; max-width: calc(100% - 240px); overflow-x: auto; }
.story-selector.visible { display: flex; }
.story-tab { padding: 8px 14px; font-size: 12px; font-weight: 500; border-radius: var(--radius-sm); cursor: pointer; white-space: nowrap; background: transparent; color: var(--text-muted); border: none; transition: all 0.15s; }
.story-tab:hover { background: var(--surface-alt); color: var(--text); }
.story-tab.active { background: var(--primary); color: white; }
.diagram-controls { position: absolute; bottom: 16px; right: 16px; display: flex; flex-direction: column; gap: 6px; z-index: 50; }
.diagram-controls .btn { box-shadow: var(--shadow); width: 42px; height: 42px; }
.zoom-indicator { position: absolute; top: 12px; right: 12px; background: var(--surface); padding: 5px 10px; border-radius: 16px; font-size: 11px; font-weight: 600; box-shadow: var(--shadow); z-index: 50; }
.flow-path { fill: none; stroke-width: 2; stroke-linecap: round; }
.flow-label { font-size: 10px; font-weight: 500; fill: var(--text); }
.flow-label-bg { fill: var(--surface); stroke: var(--border); stroke-width: 1; }
.step-badge { font-size: 9px; font-weight: 700; fill: white; }
.annotation-box { fill: #fef3c7; stroke: #fbbf24; stroke-width: 1; }
.annotation-text { font-size: 9px; fill: #92400e; }
.work-object-box { fill: #fce7f3; stroke: #ec4899; stroke-width: 1.5; }
.work-object-text { font-size: 9px; font-weight: 500; fill: #be185d; }
.control-handle { fill: var(--danger); stroke: white; stroke-width: 2; cursor: move; pointer-events: all; opacity: 0.8; }

/* Simplified Steps Display */
.steps-container { flex: 1; overflow-y: auto; padding: 14px; }
.domain-header { background: var(--primary); color: white; padding: 14px 16px; margin: -14px -14px 14px -14px; display: flex; align-items: center; gap: 8px; }
.domain-header h2 { font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
.domain-header .material-icons { font-size: 20px; }

.story-text {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  font-size: 14px;
  line-height: 1.8;
  color: var(--text);
  margin-bottom: 20px;
}

.story-text p {
  margin-bottom: 8px;
}

.story-text .flow-title {
  font-weight: 600;
  font-size: 15px;
  margin-top: 16px;
  margin-bottom: 8px;
  color: var(--text);
}

.story-text .flow-title .flow-number {
  display: inline-block;
  min-width: 32px;
  margin-right: 6px;
  color: var(--text-muted);
}

.story-text .step-number {
  display: inline-block;
  min-width: 42px;
  margin-right: 8px;
  color: var(--text-light);
  font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
  font-size: 12px;
}

.story-text .note {
  color: var(--text-muted);
  font-style: italic;
  margin-left: 4px;
}

.story-text .work-object {
  color: var(--primary);
  font-weight: 500;
}

.empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 30px; text-align: center; color: var(--text-muted); }
.empty-state .material-icons { font-size: 56px; margin-bottom: 12px; opacity: 0.4; }
.empty-state p { font-size: 14px; margin-bottom: 16px; }
.modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); z-index: 200; display: none; align-items: flex-end; justify-content: center; }
.modal-overlay.active { display: flex; }
.modal { background: var(--surface); border-radius: 20px 20px 0 0; width: 100%; max-width: 560px; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column; animation: slideUp 0.25s ease; }
@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
.modal-header { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
.modal-header h2 { font-size: 17px; }
.modal-body { flex: 1; overflow-y: auto; padding: 16px 20px; }
.syntax-block { background: var(--surface-dim); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 12px; font-family: 'SF Mono', monospace; font-size: 12px; line-height: 1.55; margin: 10px 0; white-space: pre-wrap; }
.syntax-section { margin-bottom: 18px; }
.syntax-section h3 { font-size: 13px; font-weight: 600; margin-bottom: 6px; display: flex; align-items: center; gap: 5px; }
.syntax-section h3 .material-icons { font-size: 16px; color: var(--primary); }
.syntax-section p { font-size: 12px; color: var(--text-muted); margin-bottom: 6px; }
.template-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
.template-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 12px; cursor: pointer; transition: all 0.15s; }
.template-card:hover { border-color: var(--primary); background: var(--primary-light); }
.template-card h4 { font-size: 13px; margin-bottom: 4px; display: flex; align-items: center; gap: 6px; }
.template-card h4 .material-icons { font-size: 18px; color: var(--primary); }
.template-card p { font-size: 11px; color: var(--text-muted); }
.icon-picker-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); z-index: 200; display: none; align-items: flex-end; }
.icon-picker-overlay.active { display: flex; }
.icon-picker { background: var(--surface); border-radius: 20px 20px 0 0; width: 100%; max-height: 65vh; display: flex; flex-direction: column; animation: slideUp 0.25s ease; }
.icon-picker-header { padding: 14px; border-bottom: 1px solid var(--border); }
.icon-picker-header h3 { font-size: 15px; margin-bottom: 10px; }
.icon-search { width: 100%; padding: 10px 14px; border: 1px solid var(--border); border-radius: var(--radius-sm); font-size: 15px; background: var(--surface-dim); color: var(--text); }
.icon-search:focus { outline: none; border-color: var(--primary); }
.icon-categories { display: flex; gap: 5px; margin-top: 10px; flex-wrap: wrap; }
.icon-category { padding: 5px 10px; font-size: 11px; background: var(--surface-alt); border: 1px solid var(--border); border-radius: 14px; cursor: pointer; }
.icon-category.active { background: var(--primary); color: white; border-color: var(--primary); }
.icon-grid { flex: 1; overflow-y: auto; padding: 12px; display: grid; grid-template-columns: repeat(auto-fill, minmax(72px, 1fr)); gap: 6px; }
.icon-item { display: flex; flex-direction: column; align-items: center; padding: 10px 4px; border-radius: var(--radius-sm); cursor: pointer; text-align: center; border: 1px solid transparent; }
.icon-item:hover { background: var(--primary-light); border-color: var(--primary); }
.icon-item .material-icons { font-size: 26px; color: var(--text); margin-bottom: 3px; }
.icon-item span:last-child { font-size: 9px; color: var(--text-muted); }
.toast { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); background: var(--text); color: var(--surface); padding: 10px 20px; border-radius: 20px; font-size: 13px; z-index: 300; animation: fadeInUp 0.2s ease; box-shadow: var(--shadow-lg); }
@keyframes fadeInUp { from { opacity: 0; transform: translateX(-50%) translateY(16px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }

@media (min-width: 900px) {
  .tabs { display: none; }
  .main-content { flex-direction: row; }
  .panel.editor-panel { display: flex !important; width: 380px; min-width: 300px; max-width: 450px; border-right: 1px solid var(--border); }
  .panel.diagram-panel { display: flex !important; flex: 1; flex-direction: column; }
  .panel.steps-panel { display: none !important; }
  .desktop-steps-section { border-top: 1px solid var(--border); max-height: 280px; overflow-y: auto; background: var(--surface-dim); }
  .desktop-steps-section .steps-container { padding: 12px 16px; }
  .desktop-steps-section .domain-header { margin: -12px -16px 12px -16px; padding: 10px 16px; }
  .steps-toggle { display: flex; align-items: center; justify-content: space-between; padding: 8px 16px; background: var(--surface); border-bottom: 1px solid var(--border); cursor: pointer; font-size: 13px; font-weight: 500; color: var(--text-muted); }
  .steps-toggle:hover { background: var(--surface-dim); }
  .steps-toggle .material-icons { font-size: 20px; transition: transform 0.2s; }
  .steps-toggle.collapsed .material-icons { transform: rotate(180deg); }
  .modal { border-radius: 20px; max-height: 70vh; margin: auto; }
  .icon-picker { border-radius: 20px; max-height: 55vh; max-width: 480px; margin: auto; }
}

.measure-svg { position: absolute; visibility: hidden; pointer-events: none; }
.export-container { position: absolute; left: -9999px; top: 0; background: white; padding: 20px; }
